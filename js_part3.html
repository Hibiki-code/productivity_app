<script>
    console.log('Part 3 Start');

    /* --- GOAL DETAIL LOGIC (Moved to Top) --- */

    /* --- PROGRESS LOGIC --- */
    let currentProgressGoalId = null;
    let currentProgressBaseValue = 0; // Store the "previous" value to add increment to

    function openProgressModal(id, current, title) {
        currentProgressGoalId = id;
        currentProgressBaseValue = Number(current) || 0;

        document.getElementById('pm-title').innerText = '進捗を記録';
        document.getElementById('pm-subtitle').innerText = title;
        document.getElementById('pm-notes').value = '';

        // Reset Toggle to Default (Snapshot)
        const toggle = document.getElementById('pm-mode-toggle');
        if (toggle) {
            toggle.checked = false;
            toggleProgressMode(); // UI Update
        }

        // Default Value: Current (Snapshot Mode)
        document.getElementById('pm-value').value = currentProgressBaseValue;

        const modal = document.getElementById('progress-modal');
        modal.classList.add('open');
        modal.style.display = 'flex'; // FORCE override any inline 'none'

        setTimeout(() => {
            const valInput = document.getElementById('pm-value');
            if (valInput) {
                valInput.focus();
                valInput.select();
            }
        }, 100);
    }

    function toggleProgressMode() {
        const isIncrement = document.getElementById('pm-mode-toggle').checked;
        const label = document.getElementById('pm-label-value');
        const input = document.getElementById('pm-value');

        if (isIncrement) {
            label.innerText = '今回の増分 (＋)';
            label.style.color = '#2196F3';
            input.placeholder = '例: 10';
            input.value = ''; // Clear for fresh increment input
        } else {
            label.innerText = '現在の到達値 (Snapshot)';
            label.style.color = '#333';
            input.placeholder = '例: 150';
            input.value = currentProgressBaseValue; // Restore current value
        }
    }
    window.toggleProgressMode = toggleProgressMode;

    function openProgressFromDetailPage() {
        if (!window.activeGoalDetailId || !window.activeGoalDetailData) {
            console.error('No active goal detail data found');
            return;
        }
        const g = window.activeGoalDetailData;
        const current = Number(g.metricCurrent) || 0;
        openProgressModal(g.id, current, g.title);
    }

    function closeProgressModal() {
        const modal = document.getElementById('progress-modal');
        modal.classList.remove('open');
        modal.style.display = 'none'; // FORCE hide
        currentProgressGoalId = null;
    }

    function saveGoalProgress() {
        const valInput = document.getElementById('pm-value').value;
        const notes = document.getElementById('pm-notes').value;
        const isIncrement = document.getElementById('pm-mode-toggle').checked;

        if (valInput === '') { alert('数値を入力してください'); return; }

        let finalValue = Number(valInput);

        // Increment Logic
        if (isIncrement) {
            finalValue = currentProgressBaseValue + finalValue;
        }

        const idToLog = currentProgressGoalId; // Capture ID before nulling

        // Close immediately for perceived speed
        closeProgressModal();

        const dateStr = new Date().toLocaleDateString('en-CA');

        google.script.run.withSuccessHandler((res) => {
            if (res !== 'Logged') {
                alert('エラー: ' + res);
            }

            // 1. Refresh Roadmap Data (Silent)
            google.script.run.withSuccessHandler((goals) => {
                window.loadedGoals = goals;
                renderRoadmap(); // Call the new renderRoadmap
                // 2. If Detail Page is open for this goal, refresh it
                if (window.activeGoalDetailId === idToLog) {
                    // Update Data Object
                    const updatedGoal = goals.find(g => g.id === idToLog);
                    if (updatedGoal) {
                        window.activeGoalDetailData = updatedGoal;
                        // Determine target calculation
                        const cur = Number(updatedGoal.metricCurrent) || 0;
                        const tgt = Number(updatedGoal.metricTarget) || 0;
                        const pct = (tgt > 0) ? Math.min(100, Math.max(0, (cur / tgt) * 100)) : 0;

                        // Direct DOM Update for Snapiness
                        document.getElementById('gd-current-val').innerText = cur + (updatedGoal.metricLabel || '');
                        document.getElementById('gd-progress-fill').style.width = pct + '%';

                        // Reload History
                        google.script.run.withSuccessHandler(window.renderGoalHistory).getGoalHistory(idToLog);
                    }
                }
            }).getGoalsV2();

        }).logGoalProgress(idToLog, finalValue, notes, dateStr);
    }

    /* --- EXPOSE TO GLOBAL (Fix for Scope Issues) --- */
    window.openGoalModal = openGoalModal;
    window.closeGoalModal = closeGoalModal;
    window.saveGoal = saveGoal;
    window.openMeasurementModal = openMeasurementModal;
    window.closeMeasurementModal = closeMeasurementModal;
    window.openProgressModal = openProgressModal;
    window.closeProgressModal = closeProgressModal;
    window.saveGoalProgress = saveGoalProgress;
    window.renderGoalsTab = renderGoalsTab;
    window.renderRoadmap = renderRoadmap;
    // window.openRoadmapArchive = openRoadmapArchive; // Removed
    // window.closeRoadmapArchive = closeRoadmapArchive; // Removed
    // window.activateGoal = activateGoal; // Removed
    // window.openRoadmapArchive = openRoadmapArchive; // Removed
    // window.closeRoadmapArchive = closeRoadmapArchive; // Removed

    console.log("Functions exposed to window.");


    function openJournalModal(name, item) {
        const modal = document.getElementById('journal-modal');
        if (!modal) return;
        pendingJournalItem = item;
        pendingJournalName = name;

        // Reset Inputs
        const input = document.getElementById('journal-input');
        if (input) input.value = '';

        // Dynamic Text Logic
        const sub = document.getElementById('journal-subtitle');
        const tit = document.getElementById('journal-title');

        if (tit) tit.innerText = name;

        if (sub && input) {
            if (name.includes('感謝日記')) {
                sub.innerText =
                    'どんなに些細なこと、即物的（物理的）なことでも構いません。「今、ありがたいと思えること」あるいは「問題なく機能していること」を3つ、書き出してください。';
                input.placeholder = '例：椅子が座りやすい、指が問題なく動く、雨風をしのげる部屋がある…など';
            } else if (name.includes('夢日記')) {
                sub.innerText = '覚えている範囲で、夢のあらすじやキーワードを記録しましょう。';
                input.placeholder = '例：空を飛ぶ夢を見た、懐かしい友人に会った...';
            } else {
                sub.innerText = '今日の記録を残しましょう';
                input.placeholder = '一言メモ...';
            }
        }

        modal.classList.add('open');
        modal.style.display = 'flex';

        // Auto-focus
        if (input) setTimeout(() => input.focus(), 100);
    }

    function closeJournalModal(saved) {
        const modal = document.getElementById('journal-modal');
        if (modal) {
            modal.classList.remove('open');
            modal.style.display = 'none';
        }
        if (!saved) {
            pendingJournalItem = null;
            pendingJournalName = '';
        }
    }

    function submitJournal() {
        if (!pendingJournalItem) return;
        const text = document.getElementById('journal-input').value;
        const name = pendingJournalName;
        const item = pendingJournalItem;

        closeJournalModal(true);
        // Force update to Done (Level 1)
        processHabitToggle(item, name, 1, false, true);

        google.script.run.logHabitText(currentHabitDate, name, text);
    }

    /* --- SLEEP MODAL LOGIC (NUCLEAR FIX 3: CLOCK UI) --- */

    function populateSleepTimes() {
        // Logic removed: Using native <input type="time">
    }

    function openSleepModal(name, item) {
        pendingJournalItem = item;
        pendingJournalName = name;

        // Default or Persisted values
        // If empty, set defaults.
        const s = document.getElementById('slp-time-start');
        const e = document.getElementById('slp-time-end');
        if (s && !s.value) s.value = '23:00';
        if (e && !e.value) e.value = '07:00';

        const modal = document.getElementById('sleep-modal');
        if (modal) {
            modal.classList.add('open');
            modal.style.display = 'flex';
        }
    }

    function closeSleepModal() {
        const modal = document.getElementById('sleep-modal');
        if (modal) {
            modal.classList.remove('open');
            modal.style.display = 'none';
        }
    }

    function commitSleepLog() {
        // Read Native Inputs
        const bedtime = document.getElementById('slp-time-start').value;
        const wakeup = document.getElementById('slp-time-end').value;

        // Validation
        if (!bedtime || !wakeup) {
            alert('時間を入力してください');
            return;
        }

        const item = pendingJournalItem;
        const name = pendingJournalName;

        closeSleepModal();
        processHabitToggle(item, name, 1, false, true);

        google.script.run.logSleep(currentHabitDate, bedtime, wakeup);
    }

    function updateHabitSectionCounts() {
        const sections = document.querySelectorAll('.habit-list-container');
        let totalCheked = 0;

        sections.forEach(sec => {
            const id = sec.id.replace('list-habit-', '');
            const countEl = document.getElementById('count-' + id);
            const children = sec.querySelectorAll('.habit-item').length;

            // Universal Hiding Logic: If section has no habits, hide its wrapper.
            // ID pattern: list-habit-{id} -> sec-wrapper-{id}
            const wrapper = document.getElementById('sec-wrapper-' + id);
            if (wrapper) {
                // block for Checked, what about others? Usually block is fine.
                wrapper.style.display = (children > 0) ? 'block' : 'none';
            }

            if (id === 'checked') {
                totalCheked = children;
            }

            if (countEl) {
                countEl.innerText = (children > 0) ? `(${children})` : '';
            }
        });

        // Also update the header count for checked if separate
        const checkedCountEl = document.getElementById('count-habit-checked');
        if (checkedCountEl) checkedCountEl.innerText = (totalCheked > 0) ? `(${totalCheked})` : '';
    }

    // Explicit global expose
    window.submitJournal = submitJournal;
    window.processHabitToggle = processHabitToggle;
    window.openSleepModal = openSleepModal;
    window.closeSleepModal = closeSleepModal;
    window.saveSleep = commitSleepLog;
    window.commitSleepLog = commitSleepLog;
    window.saveSleepLog = commitSleepLog;
    window.openRoadmapSelectionModal = openRoadmapSelectionModal;
    window.closeRoadmapSelectionModal = closeRoadmapSelectionModal;
    window.selectRoadmap = selectRoadmap;
    window.openRoadmapSelectionModal = openRoadmapSelectionModal;
    window.closeRoadmapSelectionModal = closeRoadmapSelectionModal;
    window.selectRoadmap = selectRoadmap;
    window.selectGoalStatus = selectGoalStatus; // Expose new function

    // --- PROJECT LOGIC ---
    function renderProjects() {
        const container = document.getElementById('project-list-container');
        if (!container) return;

        // Fetch Goals if not loaded (needed for "Active Roadmap" tag)
        if (!window.loadedGoals) {
            google.script.run.withSuccessHandler(goals => {
                window.loadedGoals = goals;
                if (!window.loadedProjects || window.loadedProjects.length === 0) {
                    fetchProjects();
                } else {
                    renderProjectsFromData(window.loadedProjects);
                }
            }).getGoalsV2();
            container.innerHTML = '<div class="spinner"></div>';
            return;
        }

        if (!window.loadedProjects || window.loadedProjects.length === 0) {
            fetchProjects();
        } else {
            renderProjectsFromData(window.loadedProjects);
        }
    }

    function fetchProjects() {
        const container = document.getElementById('project-list-container');
        if (container) container.innerHTML = '<div class="spinner"></div>';

        google.script.run.withSuccessHandler(projects => {
            window.loadedProjects = projects;
            renderProjectsFromData(projects);
        }).getProjects();
    }

    function renderProjectsFromData(projects) {
        const container = document.getElementById('project-list-container');
        if (!container) return;

        if (!projects || projects.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">No projects found</div>';
            return;
        }

        let html = '';
        projects.forEach(p => {
            // Find Active Roadmap
            let activeTag = '';
            if (window.loadedGoals) {
                // Find goal where projectId matches p.id and status is active
                const activeGoal = window.loadedGoals.find(g => String(g.projectId) === String(p.id) &&
                    g.status === 'Active');
                if (activeGoal) {
                    activeTag = `<div class="current-roadmap-tag">Running: ${activeGoal.title}</div>`;
                } else {
                    activeTag = `<div class="current-roadmap-tag" style="background:#f0f0f0; color:#aaa;">No Active Roadmap</div>`;
                }
            }

            html += `
                            <div class="card-glass project-card" onclick="openProjectDetail('${p.id}')">
                                <div class="project-title">${p.title}</div>
                                <div class="project-vision">${p.vision || 'No Vision'}</div>
                                ${activeTag}
                            </div>
                            `;
        });
        container.innerHTML = html;
    }

    function openProjectDetail(id) {
        const p = window.loadedProjects.find(x => String(x.id) === String(id));
        if (!p) return;

        window.activeProjectId = id; // Set active project ID for roadmap linking

        // Update Title (Fix for "Project Title" bug)
        const titleEl = document.getElementById('pd-page-title');
        if (titleEl) titleEl.innerText = p.title;

        // Vision text population
        document.getElementById('pd-vision-card').innerHTML = p.vision || 'No vision';

        // Filter Roadmaps
        const goals = window.loadedGoals ? window.loadedGoals.filter(g => String(g.projectId) ===
            String(id)) : [];
        const listContainer = document.getElementById('pd-roadmap-list');

        if (goals.length === 0) {
            listContainer.innerHTML = '<div style="color:#999;">No roadmaps linked.</div>';
        } else {
            let html = '';
            goals.forEach(g => {
                // reuse simplified card
                const current = Number(g.metricCurrent) || 0;
                const target = Number(g.metricTarget) || 1;
                const percent = Math.min(100, Math.max(0, (current / target) * 100));

                // Determine badge style based on status
                let statusBadge = '';
                let badgeColor = '#999'; // Default for Pending/Inactive
                let badgeText = '未着手';

                if (g.status === 'Active') {
                    badgeColor = '#2196F3'; // Blue for Active
                    badgeText = '進行中';
                } else if (g.status === 'Done') {
                    badgeColor = '#4CAF50'; // Green for Done
                    badgeText = '完了';
                }

                statusBadge = `<span style="background-color:${badgeColor}; color:white; padding:2px 8px; border-radius:10px; font-size:10px; margin-left:8px; white-space:nowrap;">${badgeText}</span>`;


                html += `
                            <div class="goal-card" style="margin-bottom:10px; padding:15px; border-radius:12px;"
                                onclick="openGoalDetail('${g.id}', 'project')">
                                <div
                                    style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:5px;">
                                    <div style="font-weight:bold; color:#333; font-size:15px; padding-right:5px;">
                                        ${g.title}</div>
                                    ${statusBadge}
                                </div>
                                <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                                    <div class="progress-container" style="flex:1; height:6px; margin-top:0;">
                                        <div class="progress-bar" style="width:${percent}%"></div>
                                    </div>
                                    <div style="font-size:11px; color:#666;">${current} / ${target}</div>
                                </div>
                            </div>
                            `;
            });
            listContainer.innerHTML = html;
        }

        // Switch
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-project-detail').classList.add('active');
    }

    // --- Roadmap Selection Logic ---
    function openRoadmapSelectionModal() {
        const modal = document.getElementById('roadmap-selection-modal');
        if (!modal) return;

        const listContainer = document.getElementById('roadmap-selection-list');
        listContainer.innerHTML = '';

        // Filter goals: not error, and NOT already in this project
        // Note: activeProjectId global should be set by openProjectDetail
        const candidates = (window.loadedGoals || []).filter(g => {
            return !g.id.startsWith('error') && g.projectId !== window.activeProjectId;
        });

        if (candidates.length === 0) {
            listContainer.innerHTML = '<div style="padding:10px; color:#aaa;">追加できるロードマップがありません</div>';
        } else {
            candidates.forEach(g => {
                const div = document.createElement('div');
                div.className = 'card-glass';
                div.style.padding = '10px';
                div.style.cursor = 'pointer';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.onclick = () => selectRoadmap(g.id);
                div.innerHTML = `
                            <div style="font-weight:bold;">${g.title}</div>
                            <div style="font-size:12px; color:#aaa;">${g.metricLabel || ''}</div>
                            `;
                listContainer.appendChild(div);
            });
        }

        modal.classList.add('open');
        modal.style.display = 'flex';
    }

    function closeRoadmapSelectionModal() {
        const modal = document.getElementById('roadmap-selection-modal');
        if (modal) {
            modal.classList.remove('open');
            modal.style.display = 'none';
        }
    }

    function selectRoadmap(goalId) {
        if (!window.activeProjectId) return;
        closeRoadmapSelectionModal();

        // Optimistic update
        const g = window.loadedGoals.find(x => x.id === goalId);
        if (g) {
            g.projectId = window.activeProjectId;
            openProjectDetail(window.activeProjectId); // Re-render detail view
        }

        google.script.run.withSuccessHandler(() => {
            // Silent success or re-fetch
        }).updateGoalProject(goalId, window.activeProjectId);
    }

    function closeProjectDetail() {
        document.getElementById('view-project-detail').classList.remove('active');
        document.getElementById('view-projects').classList.add('active');
    }

    function openProjectModal() {
        document.getElementById('p-title').value = '';
        document.getElementById('p-vision').value = '';
        document.getElementById('project-modal').classList.add('open');
        document.getElementById('project-modal').style.display = 'flex';
        setTimeout(() => document.getElementById('p-title').focus(), 100);
    }

    function closeProjectModal() {
        document.getElementById('project-modal').classList.remove('open');
        document.getElementById('project-modal').style.display = 'none';
    }

    function saveProject() {
        const title = document.getElementById('p-title').value;
        const vision = document.getElementById('p-vision').value;

        if (!title) {
            alert('タイトルを入力してください');
            return;
        }

        closeProjectModal();

        // Optimistic UI
        const tempId = 'temp-' + Date.now();
        const newProj = { id: tempId, title: title, vision: vision };

        if (!window.loadedProjects) window.loadedProjects = [];
        window.loadedProjects.push(newProj);
        renderProjectsFromData(window.loadedProjects);

        google.script.run.withSuccessHandler(serverProj => {
            // Replace temp details logic handled by full re-render on next fetch,
            // or just update local ID if possible.
            // For now, simple re-fetch or manual replace.
            // Let's replace the entry in loadedProjects and re-render.
            const idx = window.loadedProjects.findIndex(p => p.id === tempId);
            if (idx >= 0 && serverProj) {
                window.loadedProjects[idx] = serverProj;
                renderProjectsFromData(window.loadedProjects);
            }
        }).createProject(title, vision);
    }


    // -------------------------------------------------------------------------
    // EXPERIENCE LOGIC
    // -------------------------------------------------------------------------
    function fetchExperiences() {
        const container = document.getElementById('experience-grid');
        if (!container) return;

        // If empty, show loading
        if (container.children.length === 0 || container.innerHTML.includes('Loading')) {
            container.innerHTML = '<div class="spinner"></div>';
        }

        google.script.run.withSuccessHandler(list => {
            window.loadedExperiences = list;
            renderExperiences(list);
        }).getExperiences();
    }

    function renderExperiences(list) {
        const container = document.getElementById('experience-grid');
        if (!container) return;

        if (!list || list.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#aaa;">No experiences found.</div>';
            return;
        }

        let html = '';
        list.forEach(item => {
            const imgUrl = item.image ? item.image :
                'https://via.placeholder.com/300x200?text=No+Image';

            html += `
                            <div class="exp-card" onclick="openExperienceDetail('${item.id}')"
                                style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05); cursor:pointer;">
                                <div class="exp-img"
                                    style="height:120px; background-image:url('${imgUrl}'); background-size:cover; background-position:center;">
                                </div>
                                <div class="exp-content" style="padding:10px;">
                                    <div class="exp-title"
                                        style="font-weight:800; font-size:14px; color:#333; margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                        ${item.title}</div>
                                    <div class="exp-meta"
                                        style="display:flex; flex-direction:column; gap:2px; font-size:11px; color:#666;">
                                        <span style="display:flex; align-items:center; gap:3px;"><span
                                                class="material-symbols-rounded" style="font-size:12px;">payments</span>
                                            ${item.budget ? '¥' + item.budget : '--'}</span>
                                        <span style="display:flex; align-items:center; gap:3px;"><span
                                                class="material-symbols-rounded"
                                                style="font-size:12px;">location_on</span> ${item.location ||
                '--'}</span>
                                        <span style="display:flex; align-items:center; gap:3px;"><span
                                                class="material-symbols-rounded" style="font-size:12px;">schedule</span>
                                            ${item.duration || '--'}</span>
                                    </div>
                                </div>
                            </div>
                            `;
        });
        container.innerHTML = html;
    }

    function openExperienceDetail(id) {
        const item = (window.loadedExperiences || []).find(x => String(x.id) === String(id));
        if (!item) return;

        document.getElementById('edm-id').value = item.id;

        document.getElementById('edm-title').value = item.title;
        document.getElementById('edm-status').value = item.status;
        document.getElementById('edm-budget').value = item.budget;
        document.getElementById('edm-duration').value = item.duration;
        document.getElementById('edm-location').value = item.location;
        document.getElementById('edm-desc').value = item.description;

        // Image
        const imgUrl = item.image || '';
        document.getElementById('edm-img-container').style.backgroundImage = `url('${imgUrl}')`;
        document.getElementById('edm-image-input').value = imgUrl;

        // Map URL (stored in item.url)
        document.getElementById('edm-map-url').value = item.url;
        // Init logic
        handleLocationInput(document.getElementById('edm-location'));
        detectDescriptionLink();

        const modal = document.getElementById('experience-detail-modal');
        modal.classList.add('open');
        modal.style.display = 'flex';
    }

    function detectDescriptionLink() {
        const desc = document.getElementById('edm-desc').value;
        const linkBtn = document.getElementById('edm-desc-link-btn');
        const linkText = document.getElementById('edm-desc-link-text');

        // Simple regex for URL
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const match = desc.match(urlRegex);

        if (match && match.length > 0) {
            const url = match[0];
            linkBtn.href = url;
            linkText.innerText = 'Go to: ' + new URL(url).hostname;
            linkBtn.style.display = 'flex';
        } else {
            linkBtn.style.display = 'none';
        }
    }

    function handleLocationInput(input) {
        const val = input.value;
        const mapUrlField = document.getElementById('edm-map-url');
        const mapBtn = document.getElementById('edm-map-btn');

        if (val.includes('maps.google.com') || val.includes('goo.gl/maps') ||
            val.includes('google.com/maps')) {
            // It's a map URL
            // Try to extract name if possible, or just set URL
            // Google Maps URL usually has /place/NAME/...
            const placeRegex = /\/place\/([^\/]+)/;
            const match = val.match(placeRegex);

            if (match && match[1]) {
                // Decode and replace + with space
                const name = decodeURIComponent(match[1].replace(/\+/g, ' '));
                input.value = name;
            }

            mapUrlField.value = val; // Store full URL
            mapBtn.style.display = 'inline-block';
        } else {
            // Not a URL, treat as name
            // If empty, hide map link unless we search
            // We can search map with this name
            mapUrlField.value = '';
            mapBtn.style.display = val ? 'inline-block' : 'none';
        }
    }

    function openMap() {
        const mapUrl = document.getElementById('edm-map-url').value;
        const locationName = document.getElementById('edm-location').value;

        if (mapUrl) {
            window.open(mapUrl, '_blank');
        } else if (locationName) {
            // Search Google Maps
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationName)}`,
                '_blank');
        }
    }

    // Updated Auto Save


    // expose new functions
    window.detectDescriptionLink = detectDescriptionLink;
    window.handleLocationInput = handleLocationInput;
    window.openMap = openMap;

    function autoSaveExperience() {
        const id = document.getElementById('edm-id').value;
        const title = document.getElementById('edm-title').value;
        const status = document.getElementById('edm-status').value;
        const budget = document.getElementById('edm-budget').value;
        const duration = document.getElementById('edm-duration').value;
        const location = document.getElementById('edm-location').value;
        const description = document.getElementById('edm-desc').value;
        const url = document.getElementById('edm-url').value;
        const image = document.getElementById('edm-image-input').value;

        // If title is cleared, maybe don't save? Or allow it?
        // For auto-save, we can't block easily with alert.
        // Let's check basics.
        if (!title) return; // Do not save if title missing.

        const item = {
            id: id,
            title: title,
            status: status,
            budget: budget,
            duration: duration,
            location: location,
            description: description,
            url: url,
            image: image
        };

        const statusLabel = document.getElementById('edm-save-status');
        if (statusLabel) statusLabel.innerText = 'Saving...';

        google.script.run.withSuccessHandler(res => {
            if (statusLabel) statusLabel.innerText = 'Saved';
            // Slight delay then clear?
            setTimeout(() => { if (statusLabel.innerText === 'Saved') statusLabel.innerText = ''; },
                2000);

            // Should we refresh the list immediately?
            // It might cause jitter if typing fast.
            // Maybe only refresh on close? Or update local list 'loadedExperiences'
            updateLocalExperience(item);
        }).saveExperience(item);
    }

    function updateLocalExperience(updatedItem) {
        if (!window.loadedExperiences) return;
        const idx = window.loadedExperiences.findIndex(x => String(x.id) === String(updatedItem.id));
        if (idx !== -1) {
            window.loadedExperiences[idx] = updatedItem;
        } else {
            window.loadedExperiences.push(updatedItem);
        }
    }

    window.fetchExperiences = fetchExperiences;
    window.renderExperiences = renderExperiences;
    window.openExperienceDetail = openExperienceDetail;
    window.closeExperienceDetail = function () {
        const modal = document.getElementById('experience-detail-modal');
        modal.classList.remove('open');
        modal.style.display = 'none';
        // Refresh list on close to reflect edits
        fetchExperiences();
    };
    window.autoSaveExperience = autoSaveExperience;
    // End of Script
    console.log('Part 3 End');
</script>