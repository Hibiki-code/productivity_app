<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Life OS</title>
  <link
    href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&family=Nunito:wght@600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <style>
    /* ... existing styles ... */
    #migration-btn {
      position: fixed !important;
      top: 10px !important;
      left: 10px !important;
      bottom: auto !important;
      width: 200px !important;
      height: 60px !important;
      font-size: 20px !important;
      z-index: 2147483647 !important;
      background: red !important;
      color: white !important;
      border: 4px solid yellow !important;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5) !important;
      cursor: pointer;
    }

    :root {
      --bg-color: #FDF9E8;
      --primary: #5E6CD8;
      --text: #4A4A4A;
      --text-sub: #999;
      --warm-orange: #FF9F43;
      --bg-card: #FFF;
      --radius: 18px;
    }

    body {
      font-family: 'M PLUS Rounded 1c', 'Nunito', sans-serif;
      background-color: var(--bg-color);
      color: var(--text);
      margin: 0;
      padding: 0;
      padding-bottom: 90px;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .header {
      padding: 30px 20px 10px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-color);
    }

    .header-title {
      font-size: 20px;
      font-weight: 800;
      color: #555;
    }

    .view {
      display: none;
      padding: 0 16px;
    }

    .view.active {
      display: block;
    }

    /* Task Sections */
    .section-container {
      background: rgba(0, 0, 0, 0.02);
      border-radius: var(--radius);
      margin-bottom: 15px;
      overflow: hidden;
    }

    .section-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: 800;
      font-size: 14px;
    }

    .list-content {
      display: grid;
      grid-template-rows: 1fr;
      transition: grid-template-rows 0.3s ease-out;
    }

    .list-content>div {
      overflow: hidden;
    }

    .list-content.collapsed {
      grid-template-rows: 0fr;
    }

    .habit-list-container {
      display: grid;
      grid-template-rows: 1fr;
      transition: grid-template-rows 0.3s ease-out;
    }

    .habit-list-container>div {
      overflow: hidden;
    }

    .habit-list-container.collapsed {
      grid-template-rows: 0fr;
    }

    .toggle-icon {
      transition: transform 0.3s;
      display: inline-block;
    }

    .section-header.closed .toggle-icon {
      transform: rotate(180deg);
    }

    .task-item {
      background: #FFF;
      padding: 14px 16px;
      border-radius: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .task-item.done {
      opacity: 0.6;
    }

    .task-check {
      width: 22px;
      height: 22px;
      border: 2px solid #E0E0E0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .task-item.done .task-check {
      background: #CCC;
      border-color: #CCC;
    }

    .task-content {
      flex: 1;
      font-weight: 700;
      font-size: 15px;
    }

    .task-item.done .task-content {
      text-decoration: line-through;
      color: #999;
    }

    .btn-add-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #AAA;
      font-size: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    /* Habit Styles (TickTick) */
    .section-habit {
      margin-bottom: 15px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 16px;
      overflow: hidden;
    }



    .habit-item {
      background: white;
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .habit-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #E0E0E0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 15px;
      color: white;
    }

    .habit-item:nth-child(3n+1) .habit-icon {
      background: #81C784;
    }

    .habit-item:nth-child(3n+2) .habit-icon {
      background: #64B5F6;
    }

    .habit-item:nth-child(3n+3) .habit-icon {
      background: #FFB74D;
    }

    .habit-info {
      flex: 1;
    }

    .habit-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .habit-stats-right {
      text-align: right;
      min-width: 80px;
    }

    .habit-check-area {
      padding: 10px;
      margin-left: 10px;
      cursor: pointer;
    }

    .check-circle {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #EEE;
    }

    .habit-item.done {
      opacity: 0.7;
    }

    .habit-item.done .check-circle {
      background: var(--warm-orange);
      border-color: var(--warm-orange);
      position: relative;
    }

    .habit-item.done .check-circle::after {
      content: 'âœ“';
      color: white;
      font-size: 14px;
      position: absolute;
      top: 1px;
      left: 5px;
    }

    /* Calendar Strip */
    .calendar-strip {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      background: var(--bg-color);
      margin-bottom: 10px;
    }

    .date-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 6px;
      border-radius: 20px;
      min-width: 36px;
    }

    .date-item.active {
      background: #FFF;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .date-label {
      font-size: 10px;
      font-weight: 700;
      color: #999;
    }

    /* --- SECTION CONTAINERS (Grouping) --- */
    .section-container {
      margin-bottom: 5px;
      background: transparent;
      border-radius: 12px;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .section-container.expanded {
      background: transparent;
      /* Transparent to show gaps */
      padding-bottom: 5px;
      margin-bottom: 12px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      /* Slightly more padding */
      background: #FFFFFF;
      border-radius: 12px !important;
      /* Full radius by default */
      cursor: pointer;
      font-size: 0.95em;
      margin-bottom: 10px;
      /* Gap between header and first task */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      /* Restore shadow for card look */
    }

    .section-container.expanded .section-header {
      /* Keep rounded corners */
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      /* No Separator line */
      border-bottom: none;
    }

    .list-content {
      /* Padding inside the card - Removed to align width */
      padding: 0;
    }

    .list-content>div {
      /* Inner wrapper */
    }

    /* Task Item adjustments for inside card */
    .task-wrapper {
      margin-bottom: 0;
      /* Remove vertical gaps for unity */
      box-shadow: none;
      /* Remove shadow inside card? Or keep? */
      /* If we want "unity", maybe tasks should look cleaner */
      border-bottom: 1px solid #eee;
      /* Light separator */
      border-radius: 0;
      /* Square borders for stack */
      background: transparent;
      /* Slightly distinct from white card? or just white */
    }

    .task-wrapper:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }

    /* Enforce White Background on Task Item always */
    /* Enforce White Background on Task Item always */
    .task-item {
      background: #FFF !important;
      /* Always opaque */
      padding: 8px 14px;
      position: relative;
      z-index: 1;
      /* Ensure above actions */
    }

    .task-item.done {
      opacity: 1 !important;
      /* No container transparency */
      background: #F8F8F8 !important;
      /* Light gray solid background */
    }

    .task-item.done .task-content,
    .task-item.done .check-area {
      opacity: 0.5;
      /* Dim content only */
      /* filter: grayscale(100%); Optional */
    }

    .task-item.done .task-name {
      text-decoration: line-through;
      color: #888;
    }

    /* Clean up the expanded rule too just in case */
    .section-container.expanded .task-item {
      background: #FFF !important;
    }

    /* Swipe actions */
    /* Swipe actions */
    .task-wrapper {
      position: relative;
      overflow: visible;
      /* Ensure nothing is clipped */
    }

    .task-actions {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      display: flex;
      align-items: center;
      z-index: 1;
      /* Above base, below item */
      padding: 0 15px;
      /* Spacing from edge */
      box-sizing: border-box;
    }

    .task-actions.left {
      justify-content: flex-start;
    }

    .task-actions.right {
      justify-content: flex-end;
    }

    .task-item {
      position: relative;
      z-index: 10;
      /* Definitely above actions */
    }

    .task-actions .action-btn {
      pointer-events: auto;
      padding: 0 15px;
      height: 100%;
      border-radius: 8px;
      /* Slightly rounded */
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      box-shadow: none;
      margin-left: 5px;
    }

    .delete-btn {
      background: #FF5252;
    }

    .archive-btn {
      background: #5E6CD8;
    }

    .unarchive {
      background: #8D6E63;
    }

    /* For Archive List */

    border-radius: 50%;
    }

    .date-item.active .date-num {
      background: var(--warm-orange);
      color: white;
    }

    /* Modals */
    .modal-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      z-index: 3000;
      display: none;
      flex-direction: column;
      animation: fadeIn 0.2s;
      overflow-y: auto;
    }

    .modal-fullscreen.open {
      display: flex;
    }

    .detail-header {
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-hero {
      text-align: center;
      padding: 20px;
    }

    .detail-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .detail-title {
      font-size: 22px;
      font-weight: 800;
      color: #444;
    }

    .detail-stats-row {
      display: flex;
      justify-content: space-around;
      padding: 10px 20px;
    }

    .stat-box {
      background: white;
      border-radius: 16px;
      padding: 15px;
      width: 40%;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
    }

    .stat-num {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
    }

    .stat-label {
      font-size: 11px;
      color: #999;
      font-weight: 700;
      margin-top: 4px;
    }

    .calendar-card {
      background: white;
      border-radius: 20px;
      margin: 20px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-weight: 800;
      color: #555;
    }

    .cal-arrow {
      font-size: 24px;
      padding: 0 10px;
      cursor: pointer;
      color: #888;
    }

    .cal-arrow.disabled {
      opacity: 0.2;
      pointer-events: none;
    }

    /* Class added by JS */

    .detail-cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      text-align: center;
    }

    .cal-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border-radius: 50%;
      font-weight: 700;
      color: #555;
      box-sizing: border-box;
      /* Important for border */
    }

    .cal-header-cell {
      color: #999;
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    /* Calendar Status Colors */
    .cal-cell.status-done {
      background: var(--warm-orange);
      color: white;
      border: 2px solid var(--warm-orange);
      /* Match size */
    }

    .cal-cell.status-failed {
      background: transparent;
      color: #555;
      border: 3px solid #D0D0D0;
      /* Visible Gray Ring */
    }

    /* Gray for missed */
    .cal-cell.status-none {}

    /* Future or none */

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 70px;
      background: white;
      border-top: 1px solid #F0F0F0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #CCC;
      width: 60px;
      font-size: 10px;
      font-weight: 700;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-icon {
      font-size: 22px;
      margin-bottom: 4px;
    }

    /* Modal Simple */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 3100;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-box {
      background: white;
      width: 85%;
      max-width: 360px;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .btn-save {
      width: 100%;
      padding: 14px;
      background: #333;
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 800;
      margin-top: 10px;
      cursor: pointer;
    }

    .input-std {
      width: 100%;
      padding: 12px;
      border: 1px solid #EEE;
      border-radius: 8px;
      box-sizing: border-box;
      margin-bottom: 10px;
      font-family: inherit;
    }

    .glass-header {
      position: sticky;
      top: 0;
      z-index: 100;
      /* Parent handles layout & text, background handled by ::before */
      padding: 35px 20px 15px;
      font-size: 28px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.5px;
      isolation: isolate;
      /* Create stacking context */
    }

    .glass-header::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: -1;

      /* Blur Effect */
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      /* Background Gradient: Top(0.25) -> Bottom(0) Smooth Fade */
      background: linear-gradient(to bottom,
          rgba(253, 249, 232, 0.25) 0%,
          rgba(253, 249, 232, 0) 100%);

      /* Smooth Blur Fade-out using Mask */
      -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
      mask-image: linear-gradient(to bottom, black 50%, transparent 100%);

      pointer-events: none;
    }

    .toggle-icon {
      transition: transform 0.3s ease;
      font-size: 12px;
      color: #999;
    }

    /* Calendar Strip Sticky */
    .calendar-strip {
      position: sticky;
      top: 85px;
      /* Approximate header height */
      z-index: 90;
      background: transparent !important;
      /* Completely transparent */
      padding: 10px 0;
      /* Remove border if it exists or keep it? User said "completely transparent" bar.
  Usually strip has border-bottom. Let's inspect/assume no background. */
      display: flex;
      justify-content: space-around;
      /* margin-bottom: 20px; -> Keep margin */
    }

    /* Sortable Feedback */
    .sortable-ghost {
      opacity: 0.4;
      background: #f0f0f0;
    }

    .sortable-drag {
      cursor: grabbing;
      opacity: 0.9;
      transform: scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      z-index: 9999;
    }

    .view {
      display: none;
      padding: 0 16px;
      padding-top: 0;
    }

    .fade-collapse {
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0 !important;
      max-height: 0 !important;
      margin-top: 0 !important;
      margin-bottom: 0 !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      transform: scale(0.9);
      overflow: hidden;
    }


    .view.active {
      display: block;
    }

    /* Task Animations */
    .task-anim-leave {
      animation: taskLeave 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      pointer-events: none;
      /* Prevent clicks during anim */
    }

    .task-anim-enter {
      animation: taskEnter 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes taskLeave {
      0% {
        opacity: 1;
        transform: scale(1) translateY(0);
        max-height: 100px;
        /* Approx height of task */
        margin-bottom: 0;
      }

      50% {
        opacity: 0;
        transform: scale(0.95) translateY(5px);
      }

      100% {
        opacity: 0;
        transform: scale(0.9) translateY(10px);
        max-height: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
        border-bottom: none;
      }
    }

    @keyframes taskEnter {
      0% {
        opacity: 0;
        transform: scale(0.95) translateY(-5px);
      }

      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
  </style>
</head>

<body>

  <!-- REMOVED GLOBAL HEADER -->
  <!-- 
  <div class="header">
    <div class="header-title">Life OS</div>
  </div>
  -->

  <div class="main-container">

    <!-- TASKS VIEW -->
    <div id="view-tasks" class="view active">
      <div class="glass-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div>ã‚¿ã‚¹ã‚¯</div>
        <div style="display:flex; gap:15px; align-items:center;">
          <div id="highlight-mode-btn"
            style="font-size:24px; color:#29B6F6; cursor:pointer; opacity:0.4; transition:all 0.2s;"
            onclick="toggleHighlightMode()">
            <span class="material-symbols-rounded">diamond</span>
          </div>
          <div style="font-size:24px; color:var(--primary); cursor:pointer;" onclick="toggleArchiveView()">ğŸ“‚</div>
        </div>
      </div>

      <!-- Main View -->
      <div id="task-main-view">
        <!-- High Prio -->
        <div class="section-container">
          <div class="section-header" onclick="toggleSection('high')">
            <div style="color:#FF6B6B; font-weight:bold;">é«˜ â–² (<span id="count-high">0</span>)</div>
            <div class="add-btn-small" onclick="event.stopPropagation(); openTaskModal(3)">ï¼‹</div>
          </div>
          <div id="list-high" class="list-content">
            <div></div>
          </div>
        </div>

        <!-- Med Prio -->
        <div class="section-container">
          <div class="section-header" onclick="toggleSection('med')">
            <div style="color:#E17055; font-weight:bold;">ä¸­ â— (<span id="count-med">0</span>)</div>
            <div class="add-btn-small" onclick="event.stopPropagation(); openTaskModal(2)">ï¼‹</div>
          </div>
          <div id="list-med" class="list-content">
            <div></div>
          </div>
        </div>

        <!-- Low Prio -->
        <div class="section-container">
          <div class="section-header" onclick="toggleSection('low')">
            <div style="color:#54A0FF; font-weight:bold;">ä½ â–¼ (<span id="count-low">0</span>)</div>
            <div class="add-btn-small" onclick="event.stopPropagation(); openTaskModal(1)">ï¼‹</div>
          </div>
          <div id="list-low" class="list-content">
            <div></div>
          </div>
        </div>

        <!-- Inbox -->
        <div class="section-container">
          <div class="section-header" onclick="toggleSection('none')">
            <div style="color:#888; font-weight:bold;">Inbox (<span id="count-none">0</span>)</div>
            <div class="add-btn-small" onclick="event.stopPropagation(); openTaskModal(0)">ï¼‹</div>
          </div>
          <div id="list-none" class="list-content">
            <div></div>
          </div>
        </div>

        <!-- Completed -->
        <div class="section-container completed">
          <div class="section-header" onclick="toggleSection('done')">
            <div style="color:#AAA; font-weight:bold;">å®Œäº† (<span id="count-done">0</span>)</div>
            <div class="add-btn-small" style="opacity:0; pointer-events:none;"></div>
          </div>
          <div id="list-done" class="list-content">
            <div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ARCHIVE VIEW -->
    <div id="view-archive" class="view">
      <div class="glass-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</div>
        <div style="font-size:24px; cursor:pointer;" onclick="toggleArchiveView()">âœ•</div>
      </div>
      <div id="archive-list" style="padding-bottom:100px;"></div>
    </div>

    <!-- HABITS VIEW -->
    <div id="view-habits" class="view">
      <div class="glass-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div>ç¿’æ…£</div>
        <div id="habit-date-display" style="font-size:16px; font-weight:600; color:var(--text-sub);"></div>
      </div>

      <div class="calendar-strip" id="calendar-strip">
        <!-- Loaded by JS -->
      </div>

      <div id="habit-sections-root">
        <!-- Dynamic Sections -->
      </div>

      <!-- Checked (Always last) -->
      <div class="section-habit" id="sec-wrapper-checked">
        <div class="section-header" onclick="toggleHabitSection('checked')">
          <div>å®Œäº† <span id="count-habit-checked" style="font-size:0.9em; opacity:0.8;"></span></div>
          <div class="toggle-icon">âˆ§</div>
        </div>
        <div id="list-habit-checked" class="habit-list-container">
          <div></div>
        </div>
      </div>
    </div>

    <!-- SCHEDULE VIEW -->
    <div id="view-schedule" class="view">
      <div class="glass-header">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
      <div style="text-align:center; margin-top:50px; color:#aaa;">
        Coming Soon...
      </div>
      <div id="schedule-list"></div>
    </div>

    <!-- ROADMAP VIEW -->
    <div id="view-roadmap" class="view">
      <div class="glass-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div>Roadmap</div>
        <div class="add-btn-small" onclick="openGoalModal()" style="font-size:24px; width:40px; height:40px;">ï¼‹</div>
      </div>
      <div style="padding: 0 10px 100px 10px;">
        <div id="goal-list-container"></div>
      </div>
    </div>
    <!-- GOALS TAB (New) -->
    <div id="view-goals" class="view">
      <div class="header-glass">
        <div class="header-title">Goals & Vision</div>
        <div class="add-btn-small" onclick="openGoalWizard()">+</div>
      </div>
      <div style="height:60px;"></div> <!-- Spacer -->

      <!-- Weekly Focus Widget -->
      <div id="weekly-focus-container">
        <!-- Injected via JS -->
        <div class="loading-spinner"></div>
      </div>

      <!-- Spacer -->
      <div style="height:20px;"></div>

      <!-- Roadmap / Long Term (Future) -->
      <div class="section-header">
        <span>Vision Roadmap</span>
      </div>
      <div class="goal-card" style="opacity:0.6;">
        <div class="goal-title">Create your Vision</div>
        <div style="font-size:12px; color:#999; margin-top:5px;">Define your long-term ideals... (Coming Soon)</div>
      </div>
    </div>
  </div> <!-- Main -->

  <!-- NAV BAR -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('tasks', this)">
      <div class="nav-icon">âœ“</div>
      Tasks
    </div>

    <!-- Roadmap (New) -->
    <div class="nav-item" onclick="switchTab('roadmap', this)">
      <div class="nav-icon"><span class="material-symbols-rounded">map</span></div>
      Roadmap
    </div>

    <!-- Schedule (Cal) -->
    <div class="nav-item" onclick="switchTab('cal', this)">
      <div class="nav-icon"><span class="material-symbols-rounded">calendar_month</span></div>
      Schedule
    </div>

    <!-- Habits -->
    <div class="nav-item" onclick="switchTab('habits', this)">
      <div class="nav-icon">â­•</div>
      Habits
    </div>

    <!-- Goals (Vision) -->
    <div class="nav-item" onclick="switchTab('goals', this)">
      <div class="nav-icon"><span class="material-symbols-rounded">flag</span></div>
      Goals
    </div>
  </div>

  <!-- SLEEP MODAL -->
  <div class="modal-overlay" id="sleep-modal" onclick="if(event.target===this) closeSleepModal()">
    <div class="modal-box">
      <h3>ç¡çœ è¨˜éŒ²</h3>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px;color:#666;">å°±å¯æ™‚åˆ»</label>
        <input type="time" id="sleep-bedtime" class="input-std" value="23:00">
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px;color:#666;">èµ·åºŠæ™‚åˆ»</label>
        <input type="time" id="sleep-wakeup" class="input-std" value="07:00">
      </div>
      <div class="modal-actions">
        <button class="btn-sec" onclick="closeSleepModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-pri" onclick="saveSleepLog()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- TASK MODAL -->
  <div class="modal-overlay" id="task-modal" onclick="if(event.target===this) closeTaskModal()">
    <div class="modal-box">
      <h3>ã‚¿ã‚¹ã‚¯è¿½åŠ </h3>
      <input id="t-name" class="input-std" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›">
      <select id="t-prio" class="input-std">
        <option value="3">å„ªå…ˆåº¦: é«˜</option>
        <option value="2">å„ªå…ˆåº¦: ä¸­</option>
        <option value="1">å„ªå…ˆåº¦: ä½</option>
        <option value="0" selected>ã‚¤ãƒ³ãƒœãƒƒã‚¯ã‚¹</option>
      </select>

      <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
        <input type="number" id="t-duration-h" class="input-std" placeholder="0" min="0"
          style="width:50px; text-align:center; padding:8px;"
          oninput="this.value = Math.max(0, parseInt(this.value) || 0)">
        <span style="font-size:12px; color:#666;">h</span>
        <input type="number" id="t-duration-m" class="input-std" placeholder="15" value="15" min="0" max="59"
          style="width:50px; text-align:center; padding:8px;"
          onchange="this.value = Math.max(0, Math.min(59, parseInt(this.value) || 0))">
        <span style="font-size:12px; color:#666;">m</span>
        <input type="date" id="t-date" class="input-std" style="flex:1; padding:8px;">
      </div>

      <textarea id="t-details" class="input-std" placeholder="è©³ç´°..."
        style="margin-top:10px; height:60px; resize:none; padding:8px; font-family:inherit;"></textarea>
      <button class="btn-save" onclick="saveTask()">è¿½åŠ </button>
    </div>
  </div>
  <!-- GOAL MODAL -->
  <div class="modal-overlay" id="goal-modal" onclick="if(event.target===this) closeGoalModal()">
    <div class="modal-box" style="max-height:85vh; overflow-y:auto;">
      <h3>ç›®æ¨™è¨­å®š</h3>
      <input id="g-id" type="hidden">
      <label style="font-size:12px; color:#999;">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="g-title" class="input-std" placeholder="ä¾‹: å‰¯æ¥­ã§æœˆ10ä¸‡ç¨¼ã">

      <label style="font-size:12px; color:#999;">ãƒ“ã‚¸ãƒ§ãƒ³ (å®šæ€§ç›®æ¨™)</label>
      <textarea id="g-vision" class="input-std" style="height:80px;" placeholder="é”æˆæ™‚ã®æƒ…æ™¯ãªã©..."></textarea>

      <div style="display:flex; gap:10px;">
        <div style="flex:1;">
          <label style="font-size:12px; color:#999;">å˜ä½ (ä¾‹: å††, kg)</label>
          <input id="g-metric-label" class="input-std" placeholder="å††">
        </div>
        <div style="flex:1;">
          <label style="font-size:12px; color:#999;">ç›®æ¨™å€¤</label>
          <input type="number" id="g-metric-target" class="input-std" placeholder="100000">
        </div>
      </div>

      <label style="font-size:12px; color:#999;">ç¾åœ¨å€¤</label>
      <input type="number" id="g-metric-current" class="input-std" placeholder="0">

      <div style="display:flex; gap:10px;">
        <div style="flex:1;">
          <label style="font-size:12px; color:#999;">é–‹å§‹æ—¥</label>
          <input type="date" id="g-start-date" class="input-std">
        </div>
        <div style="flex:1;">
          <label style="font-size:12px; color:#999;">é”æˆæœŸé™</label>
          <input type="date" id="g-end-date" class="input-std">
        </div>
      </div>

      <button class="btn-save" onclick="saveGoal()">ä¿å­˜</button>
    </div>
  </div>

  <div class="modal-overlay" id="journal-modal" onclick="if(event.target===this) closeJournalModal(false)">
    <div class="modal-box">
      <h3 id="journal-title">ç¿’æ…£ã®è¨˜éŒ²</h3>
      <p id="journal-prompt" style="font-size:12px; color:#666; margin-bottom:10px;">ä»Šæ—¥ã‚ã£ãŸè‰¯ã„ã“ã¨ã‚„æ„Ÿè¬ã—ãŸã„ã“ã¨ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚</p>
      <textarea id="journal-input" class="input-std"
        style="height:120px; resize:none; font-family:sans-serif; line-height:1.5;"
        placeholder="ãƒ»å¤©æ°—ãŒè‰¯ã‹ã£ãŸ&#10;ãƒ»åŒåƒšã«åŠ©ã‘ã‚‰ã‚ŒãŸ&#10;..."></textarea>
      <div style="display:flex; justify-content:flex-end; gap:20px; margin-top:20px; align-items:center;">
        <div style="color:#888; font-size:14px; cursor:pointer;" onclick="closeJournalModal(false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
        <button class="btn-save" onclick="submitJournal()">è¨˜éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>
  <!-- HABIT DETAIL MODAL -->
  <div id="habit-detail-modal" class="modal-fullscreen">
    <div class="detail-header">
      <div style="font-size:24px; cursor:pointer;" onclick="closeHabitDetail()">âœ•</div>
      <div style="font-size:24px; cursor:pointer;" onclick="openHabitSettings()">â‹¯</div>
    </div>

    <div class="detail-hero">
      <div class="detail-icon">ğŸ’§</div>
      <div class="detail-title" id="detail-name">Habit Name</div>
      <div style="color:#999; font-size:12px; margin-top:5px;" id="detail-time">Time</div>
      <div style="color:#777; margin-top:10px; font-size:13px;" id="detail-desc">Benefit...</div>
    </div>

    <div class="detail-stats-row">
      <div class="stat-box">
        <div class="stat-num" id="detail-streak">-</div>
        <div class="stat-label">é€£ç¶šæ—¥æ•°</div>
      </div>
      <div class="stat-box">
        <div class="stat-num" id="detail-rate">-%</div>
        <div class="stat-label">æœˆé–“é”æˆç‡</div>
      </div>
    </div>

    <div class="calendar-card">
      <div class="section-header">
        <span>ã‚¿ã‚¹ã‚¯</span>
      </div>
      <div class="cal-header">
        <span id="btn-prev-month" class="cal-arrow" onclick="changeDetailMonth(-1)">â€¹</span>
        <span id="cal-month-label">2025å¹´ 12æœˆ</span>
        <span id="btn-next-month" class="cal-arrow next" onclick="changeDetailMonth(1)">â€º</span>
      </div>
      <div class="detail-cal-grid" id="detail-cal-grid">
        <!-- JS -->
      </div>
    </div>

    <div id="detail-journal-logs-container" style="margin:20px 20px 100px 20px;"></div>
  </div>

  <!-- HABIT SETTINGS MODAL -->
  <div class="modal-overlay" id="habit-settings-modal" onclick="if(event.target===this) closeHabitSettings()">
    <div class="modal-box">
      <h3>ç¿’æ…£è¨­å®š</h3>

      <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
        <div id="hs-icon-preview" onclick="openIconPicker()"
          style="width:50px; height:50px; background:#f0f0f0; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:24px;">
          <span class="material-symbols-rounded">add_reaction</span>
        </div>
        <div style="flex:1;">
          <label style="font-size:12px; color:#999;">ç¿’æ…£å</label>
          <input id="hs-name" class="input-std" style="margin-top:2px;">
        </div>
      </div>

      <label style="font-size:12px; color:#999;">ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label>
      <select id="hs-section" class="input-std"></select>

      <button class="btn-save" onclick="saveHabitDefinition()">ä¿å­˜</button>
    </div>
  </div>

  <!-- ICON PICKER MODAL -->
  <div class="modal-overlay" id="icon-picker-modal" onclick="if(event.target===this) closeIconPicker()">
    <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
      <h3>ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ</h3>
      <input type="text" id="icon-search" placeholder="æ¤œç´¢..." oninput="filterIcons(this.value)"
        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px;">
      <div id="icon-grid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px;">
        <!-- JS -->
      </div>
    </div>
  </div>

  <!-- SECTION MANAGER MODAL -->
  <div class="modal-overlay" id="section-manager-modal" onclick="if(event.target===this) closeSectionManager()">
    <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
      <h3>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</h3>
      <div id="sm-list" style="margin-bottom:20px;"></div>

      <button class="btn-save" style="background:#ddd; color:#333; margin-bottom:10px;" onclick="addSectionRow()">+
        ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ </button>
      <button class="btn-save" onclick="saveSections()">å¤‰æ›´ã‚’ä¿å­˜</button>
    </div>
  </div>

  <script>
    // --- STATE ---
    let currentHabitDate = new Date().toLocaleDateString('en-CA');
    let habitCalendarCache = {};
    let currentDetailHabit = null; // Object
    let currentDetailYear = 0;
    let currentDetailMonth = 0;
    let todayYear = 0; // RESTORED
    let todayMonth = 0; // RESTORED
    let habitDataCache = null; // { habits: [], sections: [] } for re-rendering

    // --- INIT ---
    window.onload = function () {
      console.log("App Started");
      // Check for Debug Errors
      const ssrError = "<?= ssrError ?>";
      if (ssrError && ssrError !== 'null' && ssrError !== '') {
        const errDiv = document.createElement('div');
        errDiv.style.background = '#ffebee';
        errDiv.style.color = '#c62828';
        errDiv.style.padding = '10px';
        errDiv.style.borderBottom = '1px solid #ef5350';
        errDiv.innerText = ssrError;
        document.body.prepend(errDiv);
      }

      // Force Migration Button Visibility
      const btn = document.getElementById('migration-btn');
      if (btn) document.body.prepend(btn);


      // 1. Render Injected Data (SSR)
      try {
        const rawTasks = <?!= initialTasksJson ?>;
        const rawHabits = <?!= initialHabitsJson ?>;

        if (rawTasks) renderTasks(rawTasks);

        initDateStrip();

        if (rawHabits) {
          renderHabits(rawHabits);
          // renderCalendar(new Date(), rawHabits); // Disabled: Function missing
        } else {
          // Fallback
          fetchHabits(new Date().toLocaleDateString('en-CA'));
        }
      } catch (e) {
        console.error("SSR Parse Error", e);
        fetchTasks();
        fetchHabits(new Date().toLocaleDateString('en-CA'));
      }

      setupModal();
      showTab('tasks');
    };

    // Programmatic Tab Switch
    function showTab(id) {
      // Find Nav Item
      const navs = document.querySelectorAll('.bottom-nav .nav-item');
      let targetEl = null;

      // Heuristic: Nav item onclick contains the ID? 
      // Or index? 
      // If standard order: 0=tasks, 1=habits, 2=schedule?
      // Let's rely on mapping if possible or just use switchTab logic manually.

      // Manual Switch without 'el' dependency if el not found
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      const view = document.getElementById('view-' + id);
      if (view) view.classList.add('active');

      document.querySelectorAll('.nav-item').forEach(n => {
        n.classList.remove('active');
        // Try to match
        if (n.innerHTML.includes(id) || (id === 'tasks' && n.innerHTML.includes('done_all')) || (id === 'habits' && n.innerHTML.includes('water_drop'))) {
          n.classList.add('active');
        }
      });

      if (id === 'habits') {
        // Refresh habits
        // fetchHabits(new Date().toLocaleDateString('en-CA')); // Optional
      }
    }

    function setupModal() {
      // Close Modals on Overlay Click
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('open');
            overlay.style.display = 'none'; // Fallback
          }
        });
      });

      // Archive Modal Close
      const arcView = document.getElementById('view-archive');
      // Archive is a view, not modal.

      // Task Modal
      const taskModal = document.getElementById('task-modal');
      if (taskModal) {
        taskModal.addEventListener('click', e => {
          if (e.target === taskModal) closeTaskModal();
        });
      }
    }

    function switchTab(id, el) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById('view-' + id).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');

      if (id === 'habits') {
        // Maybe refresh habits to be sure
      }
      if (id === 'goals') {
        renderGoalsTab();
      }
    }

    // --- TASKS ---
    function fetchTasks() {
      // Still useful for manual refresh
      google.script.run.withSuccessHandler(renderTasks).getTasks();
    }

    function renderTasks(tasks) {
      console.log('Rendering Tasks:', tasks.length);
      try {
        // Clear
        const lists = ['high', 'med', 'low', 'none', 'done'];
        lists.forEach(k => {
          const el = document.querySelector('#list-' + k + ' > div');
          if (el) el.innerHTML = '';
        });
        let counts = { 3: 0, 2: 0, 1: 0, 0: 0, done: 0 };

        tasks.forEach(t => {
          const p = Number(t.importance) || 0;
          const status = (t.status || '').trim();

          if (status === 'å®Œäº†') {
            counts.done++;
            createTaskEl(t, 'list-done');
          } else {
            counts[p]++;
            const map = { 3: 'high', 2: 'med', 1: 'low', 0: 'none' };
            createTaskEl(t, 'list-' + map[p]);
          }
        });

        // Update counts
        if (document.getElementById('count-high')) document.getElementById('count-high').innerText = counts[3];
        if (document.getElementById('count-med')) document.getElementById('count-med').innerText = counts[2];
        if (document.getElementById('count-low')) document.getElementById('count-low').innerText = counts[1];
        if (document.getElementById('count-none')) document.getElementById('count-none').innerText = counts[0];
        if (document.getElementById('count-done')) document.getElementById('count-done').innerText = counts.done;

        const doneSec = document.getElementById('sec-done');
        if (doneSec) doneSec.style.display = counts.done > 0 ? 'block' : 'none';

        initTaskSortables(); // Init Drag & Drop

      } catch (e) {
        console.error('Error rendering tasks:', e);
      }
    }

    let taskSortables = [];

    function initTaskSortables() {
      // Clean old
      taskSortables.forEach(s => s.destroy());
      taskSortables = [];

      const lists = ['high', 'med', 'low', 'none'];
      lists.forEach(k => {
        const el = document.querySelector('#list-' + k + ' > div');
        if (!el) return;

        const s = Sortable.create(el, {
          group: 'tasks',
          delay: 200, // Long press 200ms
          delayOnTouchOnly: true, // Only for touch? User said "Long press" generally. Let's keep general.
          animation: 150,
          ghostClass: 'sortable-ghost',
          dragClass: 'sortable-drag',
          onEnd: function (evt) {
            const item = evt.item;
            const toList = evt.to.closest('.list-content').id; // list-high
            const fromList = evt.from.closest('.list-content').id;

            if (toList === fromList) return; // Same list

            const map = { 'list-high': 3, 'list-med': 2, 'list-low': 1, 'list-none': 0 };
            const newPrio = map[toList] !== undefined ? map[toList] : 0;

            // Update Data
            item.dataset.prio = newPrio;

            // Update Counts Logic
            updateTaskCounts();

            // Backend Update
            const row = item.dataset.row;
            google.script.run.updateTaskPriority(row, newPrio);
          }
        });
        taskSortables.push(s);
      });
    }

    function updateTaskCounts() {
      const counts = { 3: 0, 2: 0, 1: 0, 0: 0 };
      // Valid lists only
      ['list-high', 'list-med', 'list-low', 'list-none'].forEach(id => {
        const container = document.querySelector('#' + id + ' > div');
        const count = container ? container.children.length : 0;
        // Map id to prio
        const pMap = { 'list-high': 3, 'list-med': 2, 'list-low': 1, 'list-none': 0 };
        counts[pMap[id]] = count;
      });

      // Done count is static unless moved
      const doneCount = document.querySelector('#list-done > div').children.length;

      if (document.getElementById('count-high')) document.getElementById('count-high').innerText = counts[3];
      if (document.getElementById('count-med')) document.getElementById('count-med').innerText = counts[2];
      if (document.getElementById('count-low')) document.getElementById('count-low').innerText = counts[1];
      if (document.getElementById('count-none')) document.getElementById('count-none').innerText = counts[0];
      if (document.getElementById('count-done')) document.getElementById('count-done').innerText = doneCount;
    }



    /* --- HIGHLIGHT LOGIC --- */
    let isHighlightMode = false;

    function toggleHighlightMode() {
      isHighlightMode = !isHighlightMode;
      const btn = document.getElementById('highlight-mode-btn');
      if (btn) {
        btn.style.opacity = isHighlightMode ? '1' : '0.4';
        btn.style.transform = isHighlightMode ? 'scale(1.2)' : 'scale(1.0)';
      }
      document.body.classList.toggle('highlight-mode-active', isHighlightMode);
    }

    function handleTaskTap(e, taskObj) {
      if (!isHighlightMode) return; // Normal click handled by checkbox

      // Stop checking the box
      e.preventDefault();
      e.stopPropagation();

      const id = taskObj.dataset.id; // Correct ID
      console.log('Task Tapped in Highlight Mode:', id);

      showHighlightConfirm(id);
    }

    function showHighlightConfirm(id) {
      if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’ã€Œä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ')) {
        doSetHighlight(id);
        toggleHighlightMode();
      }
    }

    function doSetHighlight(id) {
      // Optimistic UI updates
      document.querySelectorAll('.highlight-diamond').forEach(el => el.remove());

      const item = document.querySelector(`.task-item[data-id="${id}"] .task-content`);
      if (item) {
        const d = document.createElement('div');
        d.className = 'highlight-diamond';
        d.innerText = 'ğŸ’';
        item.prepend(d); // Add to UI

        google.script.run.withSuccessHandler(() => {
          // fetchTasks(); // No need to refetch if UI synced
        }).setDailyHighlight(id);
      }
    }

    /* --- TASK CREATION --- */
    function createTaskEl(t, listId) {
      const list = document.getElementById(listId);
      if (!list) return;

      const doneClass = t.status === 'å®Œäº†' ? 'done' : '';
      const checkMark = t.status === 'å®Œäº†' ? 'âœ“' : '';
      const highlightIcon = t.isHighlight ? `<div class="highlight-diamond" style="font-size:18px; margin-right:5px;">ğŸ’</div>` : '';
      const isCompleted = (t.status === 'å®Œäº†');

      const div = document.createElement('div');
      div.className = 'task-wrapper';
      div.dataset.id = t.id;

      div.innerHTML = `
        <div class="task-actions right">
           <div class="action-btn archive-btn" onclick="doArchiveTask('${t.id}')">
             <span class="material-symbols-rounded">archive</span>
           </div>
           <div class="action-btn delete-btn" style="margin-left: 10px;" onclick="doDeleteTask('${t.id}')">
             <span class="material-symbols-rounded">delete</span>
           </div>
        </div>

        <div class="task-item ${doneClass}" data-id="${t.id}" data-prio="${t.importance}" onclick="handleTaskTap(event, this)">
          <div class="task-check"
            ontouchstart="toggleTask(event, this); event.preventDefault();"
            onclick="if(!event.defaultPrevented) toggleTask(event, this);">
            ${checkMark}
          </div>

          <div class="task-content">
            <div class="test-tag"></div>
            ${highlightIcon}
            <div class="task-name">${t.name}</div>
            <div class="task-meta">
              ${t.dueDate ? `<span class="due-date">ğŸ“… ${t.dueDate.slice(5)}</span>` : ''}
              ${t.estTime ? `<span class="est-time">â± ${t.estTime}</span>` : ''}
            </div>
          </div>

           <!-- Details removed for slim view -->
        </div>
      `;

      const item = div.querySelector('.task-item');
      addSwipeLogic(item);

      div.style.opacity = '0';
      div.style.transform = 'translateY(10px)';
      if (isCompleted) {
        list.querySelector('div').prepend(div);
      } else {
        list.querySelector('div').appendChild(div);
      }

      requestAnimationFrame(() => {
        div.style.transition = 'all 0.3s ease';
        div.style.opacity = '1';
        div.style.transform = 'translateY(0)';
      });
    }

    // --- SWIPE LOGIC ---
    let openSwipes = []; // Track open elements

    function doUnarchiveTask(id) {
      if (!confirm('ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚¹ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
      removeEl(id);
      google.script.run.unarchiveTask(id);
    }

    function addSwipeLogic(el) {
      let startX = 0;
      let currentTranslate = 0;
      let isDragging = false;

      el.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        el.style.transition = 'none';
        closeAllSwipes(el); // Standard behavior
      }, { passive: true });

      el.addEventListener('touchmove', e => {
        const currentX = e.touches[0].clientX;
        const diff = currentX - startX;

        // Dead Zone & Direction Lock (Only allow left swipe)
        if (diff > 0 && !el.classList.contains('swiped-open')) return;
        if (Math.abs(diff) < 10) return;

        // Simple Translation (Limit to negative or zero)
        const trans = Math.min(0, diff);
        el.style.transform = `translateX(${trans}px)`;
        currentTranslate = trans;
        isDragging = true;
      }, { passive: true });

      el.addEventListener('touchend', e => {
        el.style.transition = 'transform 0.2s ease-out';
        isDragging = false;

        // Snap Logic - Right Side Only
        if (currentTranslate < -60) {
          // Open Right (reveals buttons)
          el.style.transform = 'translateX(-120px)'; // Enough for 2 buttons
          el.classList.add('swiped-open');
        } else {
          closeSwipe(el);
        }
        currentTranslate = 0;
      });
    }

    function closeSwipe(el) {
      el.style.transform = `translateX(0)`;
      el.classList.remove('swiped-open');
    }

    function closeAllSwipes(exceptEl) {
      document.querySelectorAll('.task-item.swiped-open').forEach(el => {
        if (el !== exceptEl) closeSwipe(el);
      });
    }

    // Tap Outside Listener
    document.addEventListener('touchstart', (e) => {
      // If target is NOT a task-item or child of swiped-open, close all
      if (!e.target.closest('.task-item.swiped-open') && !e.target.closest('.action-btn')) {
        closeAllSwipes(null);
      }
    });

    function doArchiveTask(id) {
      if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;
      removeEl(id);
      google.script.run.archiveTask(id);
    }

    function doDeleteTask(id) {
      if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ(å¾©å…ƒã§ãã¾ã›ã‚“)')) return;
      removeEl(id);
      google.script.run.deleteTaskHard(id); // Hard Delete
    }

    function removeEl(id) {
      const wrapper = document.querySelector(`.task-wrapper[data-id="${id}"]`);
      if (wrapper) {
        wrapper.style.height = wrapper.offsetHeight + 'px';
        wrapper.style.transition = 'height 0.3s, opacity 0.3s';
        setTimeout(() => {
          wrapper.style.height = '0';
          wrapper.style.opacity = '0';
          setTimeout(() => wrapper.remove(), 300);
        }, 10);
      }
    }

    // Legacy mapping (if used elsewhere)
    function deleteTask(id) { doDeleteTask(id); }
    function editTask(id) { alert('Edit disabled'); } // cleanup later

    function toggleSection(id) {
      const list = document.getElementById('list-' + id);
      if (!list) return;

      // header logic modified (no icon to rotate)
      // just toggle display and container class for grouping
      const container = list.parentElement;

      if (list.style.display === 'none') {
        list.style.display = 'block';
        if (container) container.classList.add('expanded');
      } else {
        list.style.display = 'none';
        if (container) container.classList.remove('expanded');
      }
    }

    function toggleDetails(header) {
      const item = header.closest('.task-item');
      const details = item.querySelector('.task-details');
      const icon = item.querySelector('.task-icon');

      if (details.style.display === 'none') {
        details.style.display = 'block';
        icon.innerText = 'âˆ§';
        icon.style.color = '#333';
      } else {
        details.style.display = 'none';
        icon.innerText = 'â‹';
        icon.style.color = '#CCC';
      }
    }

    function toggleTask(e, checkEl) {
      e.stopPropagation();

      const item = checkEl.closest('.task-item');
      if (!item) return;

      const wrapper = item.closest('.task-wrapper') || item;
      const id = item.dataset.id;
      // Determine new status (if currently done, make undone)
      const isDoneCurrently = item.classList.contains('done');
      const isDoneNew = !isDoneCurrently;

      // 1. Immediate Visual Update (Checkmark only)
      if (isDoneNew) {
        checkEl.innerText = 'âœ“';
        item.classList.add('done'); // Style update immediately
      } else {
        checkEl.innerText = '';
        item.classList.remove('done');
      }

      // Add Leave Animation
      wrapper.classList.add('task-anim-leave');

      // Wait for Animation
      setTimeout(() => {
        wrapper.classList.remove('task-anim-leave');

        // 2. List Move Logic
        const p = item.dataset.prio || 0;
        const map = { 3: 'high', 2: 'med', 1: 'low', 0: 'none' };
        const key = map[p];

        // Update Counts
        const countEl = document.getElementById('count-' + key);
        const doneCountEl = document.getElementById('count-done');
        let val = parseInt(countEl.innerText.match(/\d+/)[0]) || 0;
        let doneVal = parseInt(doneCountEl.innerText.match(/\d+/)[0]) || 0;

        if (isDoneNew) {
          // Move to Done Top
          const doneContainer = document.querySelector('#list-done > div');
          if (doneContainer) {
            doneContainer.prepend(wrapper);
            countEl.innerText = Math.max(0, val - 1);
            doneCountEl.innerText = doneVal + 1;
            const secDone = document.getElementById('sec-done');
            if (secDone) secDone.style.display = 'block';
          }
        } else {
          // Move back to List
          const sourceContainer = document.querySelector('#list-' + key + ' > div');
          if (sourceContainer) {
            sourceContainer.appendChild(wrapper);
            countEl.innerText = val + 1;
            doneCountEl.innerText = Math.max(0, doneVal - 1);
          }
        }

        // Animate Enter
        wrapper.classList.add('task-anim-enter');
        setTimeout(() => wrapper.classList.remove('task-anim-enter'), 400);

        // 3. Server Update
        google.script.run.withSuccessHandler((res) => {
          console.log('Task toggled', res);
        }).updateTaskStatus(id, isDoneNew);

      }, 350); // Match CSS duration
    }

    function addSwipeLogic(el) {
      let startX = 0;
      let currentX = 0;
      let isSwiping = false;
      let startTranslate = 0; // Capture state at touchstart

      // Actions are sibling. We need to find them relative to the wrapper.
      // Since 'el' is created before append, parent might be null initially.
      // We resolve 'actions' lazily on touchstart.
      let actions = null;

      el.addEventListener('touchstart', e => {
        if (!actions && el.parentElement) {
          actions = el.parentElement.querySelector('.task-actions');
        }

        const touch = e.touches[0];
        startX = touch.clientX;
        isSwiping = true;

        startTranslate = currentX;

        el.style.transition = 'none';
        if (actions) actions.style.opacity = '1'; // Reveal
      }, { passive: true });

      el.addEventListener('touchmove', e => {
        if (!isSwiping) return;
        const touch = e.touches[0];
        const diff = touch.clientX - startX;

        // Dead zone 10px (smaller)
        if (Math.abs(diff) < 10 && startTranslate === 0) return;

        // Calculate potential position
        let newX = startTranslate + diff;

        // Clamp
        if (newX > 0) newX = 0;
        if (newX < -150) newX = -150;

        // Apply
        currentX = newX;
        el.style.transform = `translateX(${currentX}px)`;

      }, { passive: true });

      const closeSwipe = () => {
        el.style.transition = 'transform 0.3s ease';
        el.style.transform = 'translateX(0)';
        currentX = 0;
        isSwiping = false;
        setTimeout(() => { if (actions && currentX === 0) actions.style.opacity = '0'; }, 300);
      };

      const openSwipe = () => {
        el.style.transition = 'transform 0.3s ease';
        el.style.transform = 'translateX(-140px)';
        currentX = -140;
        isSwiping = false;
        if (actions) actions.style.opacity = '1';
      };

      el.addEventListener('touchend', e => {
        if (!isSwiping) return;

        // Threshold logic
        // If we are mostly open, snap open
        if (currentX < -60) {
          openSwipe();
        } else {
          closeSwipe();
        }
      });
    }

    function saveTask() {
      const name = document.getElementById('t-name').value;
      const prio = document.getElementById('t-prio').value;

      // New Inputs
      const durH = document.getElementById('t-duration-h').value || 0;
      const durM = document.getElementById('t-duration-m').value || 0;
      const date = document.getElementById('t-date').value;
      const details = document.getElementById('t-details').value;

      if (!name) return;

      // Format Duration String (e.g. "2h 15m")
      let durStr = '';
      if (durH > 0) durStr += durH + 'h ';
      if (durM > 0 || durH > 0) durStr += durM + 'm';

      // Optimistic Add
      const t = {
        name: name,
        importance: prio,
        status: 'æœªå®Œäº†',
        row: 'temp-' + Date.now(),
        estTime: durStr.trim(),
        dueDate: date,
        description: details
      };

      const map = { 3: 'high', 2: 'med', 1: 'low', 0: 'none' };
      createTaskEl(t, 'list-' + map[prio]);

      closeTaskModal();

      google.script.run.withSuccessHandler(fetchTasks).addTask(t);
    }

    function openTaskModal(p) {
      document.getElementById('t-prio').value = p;

      // Reset Fields
      document.getElementById('t-name').value = '';
      document.getElementById('t-duration-h').value = '';
      document.getElementById('t-duration-m').value = '15';
      document.getElementById('t-date').value = '';
      document.getElementById('t-details').value = '';

      document.getElementById('task-modal').classList.add('open');
      document.getElementById('t-name').focus();
    }
    function closeTaskModal() { document.getElementById('task-modal').classList.remove('open'); }

    function toggleSection(id) {
      const list = document.getElementById('list-' + id);
      list.classList.toggle('collapsed');
    }


    function toggleArchiveView() {
      const v = document.getElementById('view-archive');
      const t = document.getElementById('view-tasks');

      if (document.getElementById('view-archive').classList.contains('active')) {
        document.getElementById('view-archive').classList.remove('active');
        document.getElementById('view-tasks').classList.add('active');
        document.querySelector('.bottom-nav').style.display = 'flex';
      } else {
        document.getElementById('view-tasks').classList.remove('active');
        document.getElementById('view-archive').classList.add('active');
        fetchArchivedTasks();
      }
    }

    function fetchArchivedTasks() {
      const list = document.getElementById('archive-list');
      if (list) list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Loading...</div>';
      google.script.run.withSuccessHandler(renderArchiveTasks).getArchivedTasks();
    }

    function renderArchiveTasks(tasks) {
      const container = document.getElementById('archive-list');
      if (!container) return;
      container.innerHTML = '';

      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#CCC;">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      const incomplete = tasks.filter(t => t.status !== 'å®Œäº†');
      const complete = tasks.filter(t => t.status === 'å®Œäº†');

      // Helper to create list
      const createSection = (title, listId, items, isDone) => {
        const sec = document.createElement('div');
        sec.className = 'section-container' + (isDone ? ' completed' : '');

        const count = items.length;
        sec.innerHTML = `
        <div class="section-header" onclick="toggleSection('${listId}')">
             <div style="color:${isDone ? '#AAA' : '#555'}; font-weight:bold;">${title} (${count})</div>
          </div>
        <div id="list-${listId}" class="list-content"></div>
      `;
        container.appendChild(sec);

        const listDiv = sec.querySelector(`#list-${listId}`);
        const innerDiv = document.createElement('div'); // Transition Wrapper
        listDiv.appendChild(innerDiv);

        items.forEach(t => {
          const wrapper = document.createElement('div');
          wrapper.className = 'task-wrapper';
          wrapper.innerHTML = `
        <div class="task-actions">
               <div class="action-btn unarchive" onclick="doUnarchiveTask('${t.id}')" style="background:#8D6E63;">â†©</div>
               <div class="action-btn delete" onclick="doDeleteTask('${t.id}')">âŒ</div>
          </div>
        <div class="task-item" style="background:#F9F9F9; opacity:0.9;">
          <div style="flex:1;">
            <div style="font-weight:bold; color:#555; text-decoration:${isDone ? 'line-through' : 'none'};">${t.name}</div>
            <div style="font-size:0.8em; color:#999;">${t.dueDate || ''}</div>
          </div>
        </div>
      `;
          const item = wrapper.querySelector('.task-item');
          addSwipeLogic(item);
          innerDiv.appendChild(wrapper);
        });
      };

      if (incomplete.length > 0) createSection('æœªå®Œäº†', 'arc-inc', incomplete, false);
      if (complete.length > 0) createSection('å®Œäº†', 'arc-com', complete, true);
    }

    /* --- HABITS --- */
    function fetchHabits(dateStr) {
      const root = document.getElementById('habit-sections-root');
      if (root) root.style.opacity = '0.4';
      google.script.run.withSuccessHandler((data) => {
        if (root) root.style.opacity = '1.0';
        renderHabits(data);
      }).getHabitStatus(dateStr);
    }

    function initDateStrip() {
      const strip = document.getElementById('calendar-strip');
      strip.innerHTML = '';
      const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const today = new Date();

      for (let i = 6; i >= 0; i--) {
        const d = new Date(); d.setDate(today.getDate() - i);
        const isToday = i === 0;
        const ymd = d.toLocaleDateString('en-CA');

        const el = document.createElement('div');
        el.className = 'date-item' + (isToday ? ' active' : '');
        el.onclick = () => {
          document.querySelectorAll('.date-item').forEach(e => e.classList.remove('active'));
          el.classList.add('active');
          currentHabitDate = ymd;
          fetchHabits(ymd);
        };
        el.innerHTML = `<div class="date-label">${days[d.getDay()]}</div><div class="date-num">${d.getDate()}</div>`;
        strip.appendChild(el);
      }
    }

    function renderHabits(data) {
      // Cache Logic
      habitDataCache = data;
      if (data.serverDate) { todayYear = data.serverDate.year; todayMonth = data.serverDate.month; }
      if (data.monthlyLogs) {
        const key = `${todayYear}-${todayMonth}`;
        Object.keys(data.monthlyLogs).forEach(hName => {
          if (!habitCalendarCache[hName]) habitCalendarCache[hName] = {};
          habitCalendarCache[hName][key] = data.monthlyLogs[hName];
        });
      }

      const root = document.getElementById('habit-sections-root');
      if (!root) return;
      root.innerHTML = '';

      // Ensure sections exist (SSR fallback)
      const sections = (data.sections && data.sections.length > 0) ? data.sections : [
        { id: 'sec_morning', name: 'æœ', order: 1 },
        { id: 'sec_afternoon', name: 'æ˜¼', order: 2 },
        { id: 'sec_evening', name: 'å¤œ', order: 3 },
        { id: 'sec_other', name: 'ãã®ä»–', order: 4 }
      ];

      // Render Sections
      sections.forEach(sec => {
        const div = document.createElement('div');
        div.className = 'section-habit';
        div.id = 'sec-wrapper-' + sec.id;
        div.innerHTML = `
      <div class="section-header" onclick="toggleHabitSection('${sec.id}')">
           <div>${sec.name} <span id="count-${sec.id}" style="font-size:0.9em; opacity:0.8;"></span></div>
           <div class="toggle-icon">âˆ§</div>
      </div>
    <div id="list-habit-${sec.id}" class="habit-list-container">
      <div><!-- Inner --></div>
    </div>
  `;
        root.appendChild(div);
      });

      // Clear Checked
      const checkedInner = document.querySelector('#list-habit-checked > div');
      if (checkedInner) checkedInner.innerHTML = '';
      const countChecked = document.getElementById('count-habit-checked');
      if (countChecked) countChecked.innerText = '0';
      let checkedCount = 0;

      if (!data.habits) { updateHabitSectionCounts(); return; }

      data.habits.forEach(h => {
        const isDone = (h.status === 1);

        if (isDone) {
          const div = createHabitCard(h, true);
          const target = document.querySelector('#list-habit-checked > div');
          if (target) target.appendChild(div);
          checkedCount++;
        } else {
          // Find section
          let targetSecId = h.sectionId || 'sec_other';
          // Verify section exists in DOM
          if (!document.getElementById('list-habit-' + targetSecId)) targetSecId = 'sec_other';

          const div = createHabitCard(h, false);
          // Append to section
          const container = document.querySelector(`#list-habit-${targetSecId} > div`);
          if (container) container.appendChild(div);
        }
      });

      updateHabitSectionCounts(); // Initial calculations

      const checkedSec = document.getElementById('sec-wrapper-checked');
      if (checkedSec) {
        if (checkedCount > 0) {
          checkedSec.style.display = 'block';
          if (countChecked) countChecked.innerText = '(' + checkedCount + ')';
        } else {
          checkedSec.style.display = 'none';
        }
      }
    }
    function createHabitCard(h, isDone) {
      const div = document.createElement('div');
      div.className = 'habit-item' + (isDone ? ' done' : '');
      div.onclick = () => openHabitDetail(h);

      let iconContent = 'ğŸ’§';
      if (h.icon) {
        iconContent = `<span class="material-symbols-rounded" style="font-size:24px;">${h.icon}</span>`;
      }

      div.innerHTML = `
        <div class="habit-icon">${iconContent}</div>
           <div class="habit-info">
              <div class="habit-name">${h.name}</div>
           </div>
           <div class="habit-stats-right">
              <div style="font-size:16px; font-weight:bold; color:var(--primary)">${h.streak || 0}æ—¥</div>
              <div style="font-size:10px; color:#999">ç¾åœ¨ã®é€£ç¶š</div>
           </div>
           <div class="habit-check-area" onclick="event.stopPropagation(); toggleHabit(this, '${h.name}')">
              <div class="check-circle"></div>
           </div>
      `;
      // Store Section ID for return
      div.dataset.sectionId = h.sectionId || 'sec_other';
      return div;
    }

    let pendingJournalItem = null;
    let pendingJournalName = '';

    function toggleHabit(el, name) {
      const item = el.closest('.habit-item');
      const isDone = item.classList.toggle('done');

      // Special Logic: Sleep Record
      if (isDone && name === 'ç¡çœ æ™‚é–“è¨˜éŒ²') {
        pendingJournalItem = item;
        pendingJournalName = name;
        document.getElementById('sleep-modal').classList.add('open');
        return;
      }

      // Special Logic: Any "Journal" (XXæ—¥è¨˜) (Only on Check)
      if (isDone && name.endsWith('æ—¥è¨˜')) {
        pendingJournalItem = item;
        pendingJournalName = name;


        const pEl = document.getElementById('journal-prompt');
        if (name === 'æ„Ÿè¬æ—¥è¨˜') {
          pEl.innerText = 'ä»Šæ—¥ã‚ã£ãŸè‰¯ã„ã“ã¨ã‚„æ„Ÿè¬ã—ãŸã„ã“ã¨ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚';
        } else {
          pEl.innerText = name + ' ã®è¨˜éŒ²ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        }

        document.getElementById('journal-modal').classList.add('open');
        document.getElementById('journal-input').value = '';
        setTimeout(() => document.getElementById('journal-input').focus(), 100);
        return;
      }

      processHabitToggle(item, name, isDone);
    }

    function closeSleepModal(isSaved) {
      document.getElementById('sleep-modal').classList.remove('open');
      // If canceled (not saved), revert check
      if (!isSaved && pendingJournalItem) {
        pendingJournalItem.classList.remove('done');
      }
      if (!isSaved) pendingJournalItem = null;
      // Keep pendingJournalItem if saved? No, saveSleepLog needs it. 
      // But saveSleepLog calls closeSleepModal FIRST. 
      // So we should NOT null it if saved, OR capture it before closing.
      // saveSleepLog already captures it: const item = pendingJournalItem;
      // So we can null it here.
      pendingJournalItem = null;
    }

    function saveSleepLog() {
      const bedtime = document.getElementById('sleep-bedtime').value;
      const wakeup = document.getElementById('sleep-wakeup').value;

      const item = pendingJournalItem;
      const name = pendingJournalName;

      closeSleepModal(true); // Close first, pass true to keep checkmark

      // Save to Backend
      // We also need today's date context? 
      // toggleHabit operates on "Today" usually. 
      // If we support back-dating, we need the date from the column/header.
      // But currently habits are "Today's View".
      // We'll assume Today.
      const dateStr = new Date();

      google.script.run.withSuccessHandler(() => {
        // Success
        processHabitToggle(item, name, true);
      }).logSleep(dateStr.toString(), bedtime, wakeup);
    }

    function processHabitToggle(item, name, isDone) {
      // Sync Backend
      google.script.run.logHabit(currentHabitDate, name, isDone);

      // Streak Optimistic Update
      const streakEl = item.querySelector('.habit-stats-right > div:first-child');
      let currentStreak = parseInt(streakEl.innerText.replace('æ—¥', '')) || 0;

      if (isDone) {
        // --- CHECKING ---
        streakEl.innerText = (currentStreak + 1) + 'æ—¥'; // Optimistic Increment

        item.classList.add('fade-collapse');
        setTimeout(() => {
          document.querySelector('#list-habit-checked > div').prepend(item);
          document.getElementById('sec-wrapper-checked').style.display = 'block';

          // Update counts
          const countEl = document.getElementById('count-habit-checked');
          const currentVal = parseInt(countEl.innerText.replace(/\D/g, '')) || 0;
          countEl.innerText = '(' + (currentVal + 1) + ')';

          item.classList.remove('fade-collapse');
          updateHabitSectionCounts();
        }, 500);

      } else {
        // --- UNCHECKING ---
        streakEl.innerText = Math.max(0, currentStreak - 1) + 'æ—¥'; // Optimistic Decrement

        item.classList.add('fade-collapse');
        setTimeout(() => {
          const secId = item.dataset.sectionId || 'sec_other';
          let container = document.querySelector('#list-habit-' + secId + ' > div');
          if (!container) container = document.querySelector('#list-habit-sec_other > div');

          container.appendChild(item);

          // Update counts
          const countEl = document.getElementById('count-habit-checked');
          const currentVal = parseInt(countEl.innerText.replace(/\D/g, '')) || 0;
          let c = currentVal - 1;
          c = c > 0 ? c : 0;
          countEl.innerText = '(' + c + ')';

          if (c <= 0) document.getElementById('sec-wrapper-checked').style.display = 'none';

          item.classList.remove('fade-collapse');
          updateHabitSectionCounts();
        }, 500);
      }
    }

    function closeJournalModal(saved) {
      document.getElementById('journal-modal').classList.remove('open');
      if (!saved && pendingJournalItem) {
        // Cancelled: Revert the checkbox visually
        pendingJournalItem.classList.toggle('done');
        pendingJournalItem = null;
      }
    }

    function submitJournal() {
      const text = document.getElementById('journal-input').value;
      if (!text.trim()) {
        alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      // Log Text
      google.script.run.logHabitText(currentHabitDate, pendingJournalName, text);

      // Proceed with completions
      processHabitToggle(pendingJournalItem, pendingJournalName, true);

      // Cleanup
      pendingJournalItem = null;
      document.getElementById('journal-modal').classList.remove('open');
    }

    function toggleHabitSection(id) {
      const list = document.getElementById('list-habit-' + id);
      if (!list) return;
      // Toggle display via class or inline?
      // CSS usually handles max-height transition if we use class.
      // The previous code had .collapsed?
      // Let's use simple display toggle for now to match renderHabits structure.
      // Actually renderHabits sets innerHTML but doesn't set display.
      // CSS for .habit-list-container?

      const header = list.previousElementSibling;
      const icon = header.querySelector('.toggle-icon');

      // Using style.display for simplicity as transitions can be tricky with dynamic height
      if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.innerText = 'âˆ§';
      } else {
        list.style.display = 'none';
        icon.innerText = 'â‹';
      }
    }

    function markSectionDirty(input) {
      // Can use valid visual cue
      input.style.backgroundColor = '#FFF8E1';
    }

    function updateHabitSectionCounts() {
      const sections = habitDataCache ? habitDataCache.sections : [];
      sections.forEach(sec => {
        const listId = 'list-habit-' + sec.id;
        const wrapperId = 'sec-wrapper-' + sec.id;
        const countId = 'count-' + sec.id;

        const listContainer = document.querySelector('#' + listId + ' > div');
        if (!listContainer) return;

        const count = listContainer.children.length;
        const countEl = document.getElementById(countId);
        const wrapperEl = document.getElementById(wrapperId);

        if (countEl) countEl.innerText = '(' + count + ')';

        // Auto Hide Logic (keep wrapper in DOM but hide)
        if (wrapperEl) {
          if (count === 0) {
            wrapperEl.style.display = 'none';
          } else {
            wrapperEl.style.display = 'block';
          }
        }
      });
    }

    // --- HABIT DETAIL & CALENDAR ---
    function openHabitDetail(habit) {
      currentDetailHabit = habit;
      if (!todayYear) {
        const d = new Date();
        todayYear = d.getFullYear();
        todayMonth = d.getMonth() + 1;
      }
      currentDetailYear = todayYear;
      currentDetailMonth = todayMonth;

      const titleEl = document.getElementById('detail-name');
      if (titleEl) titleEl.innerText = habit.name;

      const timeEl = document.getElementById('detail-time');
      if (timeEl) timeEl.innerText = 'æ‰€è¦æ™‚é–“: ' + (habit.time || 'æœªè¨­å®š');

      const descEl = document.getElementById('detail-desc');
      if (descEl) descEl.innerText = habit.benefit || 'ç¿’æ…£ã‚’ç¶šã‘ã¦ç›®æ¨™ã‚’é”æˆã—ã¾ã—ã‚‡ã†';

      const streakEl = document.getElementById('detail-streak');
      if (streakEl) streakEl.innerText = `${habit.streak || 0} æ—¥`;

      const rateEl = document.getElementById('detail-rate');
      if (rateEl) rateEl.innerText = `${habit.rate30 || 0}% `;

      // Journal Logs Logic
      const logContainer = document.getElementById('detail-journal-logs-container');
      if (logContainer) {
        logContainer.innerHTML = ''; // Clear previous

        if (habit.name.endsWith('æ—¥è¨˜')) {
          logContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>';
          google.script.run.withSuccessHandler(renderJournalLogs).getHabitTextLogs(habit.name);
        }
      }

      document.getElementById('habit-detail-modal').classList.add('open');

      renderDetailCalendar();
      preloadPastMonths(habit.name, currentDetailYear, currentDetailMonth);
    }

    function renderCalendar() { console.log('Calendar view not implemented'); }

    function renderJournalLogs(logs) {
      const container = document.getElementById('detail-journal-logs-container');
      if (!container) return;

      if (!logs || logs.length === 0) {
        container.innerHTML = '<div style="color:#999; text-align:center; font-size:12px;">è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = '';
      logs.forEach(log => {
        const card = document.createElement('div');
        card.style.cssText = 'background:rgba(255,255,255,0.8); border-radius:12px; padding:15px; margin-bottom:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);';
        card.innerHTML = `
        < div style = "font-size:12px; color:#888; margin-bottom:5px;" > ${log.date}</div >
          <div style="font-size:14px; color:#333; white-space:pre-wrap;">${log.text}</div>
      `;
        container.appendChild(card);
      });
    }

    function closeHabitDetail() {
      document.getElementById('habit-detail-modal').classList.remove('open');
    }

    function preloadPastMonths(habitName, year, month) {
      loadMonthInBackground(habitName, year, month - 1, 3);
    }

    function loadMonthInBackground(habitName, year, month, depth) {
      if (depth <= 0) return;
      let y = year, m = month;
      if (m < 1) { m = 12; y--; }
      const key = `${y} -${m} `;

      if (habitCalendarCache[habitName] && habitCalendarCache[habitName][key]) {
        loadMonthInBackground(habitName, y, m - 1, depth - 1);
        return;
      }

      google.script.run.withSuccessHandler(data => {
        if (!habitCalendarCache[habitName]) habitCalendarCache[habitName] = {};
        habitCalendarCache[habitName][key] = data;
        loadMonthInBackground(habitName, y, m - 1, depth - 1);
      }).getHabitCalendar(habitName, y, m);
    }

    function changeDetailMonth(delta) {
      let newM = currentDetailMonth + delta;
      let newY = currentDetailYear;

      // Fix Overflow
      if (newM > 12) { newM = 1; newY++; }
      else if (newM < 1) { newM = 12; newY--; }

      // Restrict Future
      // todayMonth is 1-12. newM is 1-12.
      if (newY > todayYear || (newY === todayYear && newM > todayMonth)) {
        return;
      }

      currentDetailYear = newY;
      currentDetailMonth = newM;
      renderDetailCalendar();
    }

    function renderDetailCalendar() {
      if (!currentDetailHabit) return;
      const year = currentDetailYear;
      const month = currentDetailMonth;
      document.getElementById('cal-month-label').innerText = `${year}å¹´ ${month} æœˆ`;

      // Arrow Style
      const btnNext = document.getElementById('btn-next-month');
      if (btnNext) {
        let isAtLimit = (year > todayYear) || (year === todayYear && month >= todayMonth);
        btnNext.style.opacity = isAtLimit ? '0.2' : '1';
        btnNext.classList.toggle('disabled', isAtLimit); // pointer-events:none via css
        // but keeping inline style logic for sureness
        btnNext.style.pointerEvents = isAtLimit ? 'none' : 'auto';
      }

      const container = document.getElementById('detail-cal-grid');
      container.innerHTML = 'Loading...';

      const key = `${year} -${month} `;
      const cache = habitCalendarCache[currentDetailHabit.name];

      const renderGrid = (map) => {
        container.innerHTML = '';
        // Headers
        ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(d => {
          const c = document.createElement('div');
          c.className = 'cal-header-cell'; c.innerText = d;
          container.appendChild(c);
        });

        const daysInMonth = new Date(year, month, 0).getDate();
        const firstDay = new Date(year, month - 1, 1).getDay();

        for (let i = 0; i < firstDay; i++) container.appendChild(document.createElement('div'));

        const today = new Date();
        // Reset time for accurate comparison
        today.setHours(0, 0, 0, 0);

        const start = currentDetailHabit.startDate ? new Date(currentDetailHabit.startDate) : new Date('2024-01-01');
        start.setHours(0, 0, 0, 0);

        for (let d = 1; d <= daysInMonth; d++) {
          const cell = document.createElement('div');
          cell.className = 'cal-cell';
          cell.innerText = d;

          const current = new Date(year, month - 1, d);

          if (current > today) {
            // Futur: Faint text
            cell.style.opacity = '0.3';
          } else if (current < start) {
            // Before Start: No mark, faint? User said "Before start day, no mark".
            // Assuming standard text but no status class.
            // Maybe simple opacity too? Or clean.
            // User said "Mark None". So just number.
          } else { // Active Range
            const status = map[d];
            if (status === 1) {
              cell.classList.add('status-done');
            } else if (current.getTime() === today.getTime()) {
              // Today & Not Done
              cell.classList.add('status-today-incomplete');
            } else {
              // Failed (0 or undefined) -> Gray Ring
              cell.classList.add('status-failed');
            }
          }
          container.appendChild(cell);
        }
      };

      if (cache && cache[key]) {
        renderGrid(cache[key]);
      } else {
        google.script.run.withSuccessHandler(data => {
          if (!habitCalendarCache[currentDetailHabit.name]) habitCalendarCache[currentDetailHabit.name] = {};
          habitCalendarCache[currentDetailHabit.name][key] = data;
          if (currentDetailYear === year && currentDetailMonth === month) {
            renderGrid(data);
          }
        }).getHabitCalendar(currentDetailHabit.name, year, month);
      }
    }

    // --- SETTINGS LOGIC ---
    let hsCurrentIcon = '';
    const popularIcons = []; // Deprecated, using materialIconsList from icons.html

    function openHabitSettings() {
      if (!currentDetailHabit) return;
      document.getElementById('habit-settings-modal').style.display = 'flex';
      document.getElementById('hs-name').value = currentDetailHabit.name;

      // Icon Init
      hsCurrentIcon = currentDetailHabit.icon || '';
      updateIconPreview();

      // Populate Sections
      const sel = document.getElementById('hs-section');
      sel.innerHTML = '';
      const sections = habitDataCache ? habitDataCache.sections : [];
      sections.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.innerText = s.name;
        if (s.id === currentDetailHabit.sectionId) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function updateIconPreview() {
      const preview = document.getElementById('hs-icon-preview');
      preview.innerHTML = hsCurrentIcon
        ? `< span class="material-symbols-rounded" style = "color:var(--primary);" > ${hsCurrentIcon}</span > `
        : `< span class="material-symbols-rounded" style = "color:#ccc;" > add_reaction</span > `;
    }

    function closeHabitSettings() {
      document.getElementById('habit-settings-modal').style.display = 'none';
    }

    function saveHabitDefinition() {
      const newName = document.getElementById('hs-name').value;
      const newSec = document.getElementById('hs-section').value;

      if (!newName) return;

      google.script.run.withSuccessHandler(() => {
        closeHabitSettings();
        closeHabitDetail(); // Close detail too to refresh
        fetchHabits();
      }).saveHabitDefinition(currentDetailHabit.name, newName, newSec, hsCurrentIcon);
    }

    // --- ICON PICKER ---
    // --- ICON PICKER ---
    function openIconPicker() {
      document.getElementById('icon-picker-modal').style.display = 'flex';
      renderIconGrid(materialIconsList.slice(0, 100));
    }

    function closeIconPicker() {
      document.getElementById('icon-picker-modal').style.display = 'none';
    }

    function renderIconGrid(icons) {
      const grid = document.getElementById('icon-grid');
      grid.innerHTML = '';
      icons.forEach(icon => {
        const div = document.createElement('div');
        div.style.cssText = 'height:50px; background:#f9f9f9; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer;';
        div.onclick = () => selectIcon(icon);
        div.innerHTML = `< span class="material-symbols-rounded" style = "font-size:24px; color:#555;" > ${icon}</span > `;
        grid.appendChild(div);
      });
    }

    function selectIcon(icon) {
      hsCurrentIcon = icon;
      updateIconPreview();
      closeIconPicker();
    }

    function filterIcons(query) {
      if (!query) { document.getElementById('icon-grid').innerHTML = ''; renderIconGrid(materialIconsList.slice(0, 100)); return; }
      const filtered = materialIconsList.filter(i => i.includes(query.toLowerCase())).slice(0, 100);
      renderIconGrid(filtered);
    }

    let sectionSortable = null;

    // --- SECTIONS ---
    function openSectionManager() {
      document.getElementById('section-manager-modal').style.display = 'flex';
      renderSectionManagerList();

      // Init Sortable
      const el = document.getElementById('sm-list');
      if (sectionSortable) sectionSortable.destroy();
      sectionSortable = Sortable.create(el, {
        handle: '.section-handle', // Drag handle class
        animation: 150
      });
    }

    function closeSectionManager() {
      document.getElementById('section-manager-modal').style.display = 'none';
      if (sectionSortable) {
        sectionSortable.destroy();
        sectionSortable = null;
      }
    }

    function renderSectionManagerList() {
      const root = document.getElementById('sm-list');
      root.innerHTML = '';

      const sections = habitDataCache ? habitDataCache.sections : [];

      sections.forEach((s, idx) => {
        const row = document.createElement('div');
        row.className = 'section-row';
        row.style.display = 'flex';
        row.style.gap = '10px';
        row.style.marginBottom = '10px';
        row.dataset.id = s.id;

        row.innerHTML = `
        < div class="section-handle" style = "cursor:move; padding-top:5px; padding-right:5px; color:#aaa;" >â˜°</div >
          <input value="${s.name}" class="input-std" style="margin:0; flex:1;" onchange="markSectionDirty(this)">
            <div style="cursor:pointer; color:red; padding-top:5px;" onclick="deleteSectionRow(this)">âœ•</div>
            `;
        root.appendChild(row);
      });
    }

    function toggleHabitSection(secId) {
      const list = document.getElementById('list-habit-' + secId);
      const wrapper = document.getElementById('sec-wrapper-' + secId);
      const icon = wrapper.querySelector('.toggle-icon');

      if (list.classList.contains('collapsed')) {
        list.classList.remove('collapsed');
        icon.style.transform = 'rotate(0deg)';
      } else {
        list.classList.add('collapsed');
        icon.style.transform = 'rotate(180deg)';
      }
    }

    function addSectionRow() {
      const root = document.getElementById('sm-list');
      const row = document.createElement('div');
      row.className = 'section-row';
      row.style.display = 'flex';
      row.style.gap = '10px';
      row.style.marginBottom = '10px';
      row.dataset.id = ''; // New

      row.innerHTML = `
            <div class="section-handle" style="cursor:move; padding-top:5px; padding-right:5px; color:#aaa;">â˜°</div>
            <input value="æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³" class="input-std" style="margin:0; flex:1;" onchange="markSectionDirty(this)">
              <div style="cursor:pointer; color:red; padding-top:5px;" onclick="deleteSectionRow(this)">âœ•</div>
              `;
      root.appendChild(row);
    }

    function deleteSectionRow(btn) {
      btn.parentElement.remove();
    }

    function saveSections() {
      const rows = Array.from(document.querySelectorAll('#sm-list > div'));
      const newSections = rows.map((r, i) => {
        const name = r.querySelector('input').value;
        const id = r.dataset.id; // Empty if new
        return { id, name, order: i + 1 };
      });

      const promises = newSections.map(s => {
        return new Promise((resolve) => {
          google.script.run.withSuccessHandler(resolve).saveHabitSection(s.id, s.name, s.order);
        });
      });

      // Handle deletions? Logic above only saves current list.
      // Deletions need separate handling or backend full sync.
      // Current backend `saveHabitSection` is update/add. `delete` is separate API.
      // Frontend doesn't track deleted IDs.
      // Hack: Just save what's there. Deleted ones remain in DB as orphans (not in list if I replace logic? No).
      // Real solution: Track text deletions?
      // For now, user just asked to "Manage Sections". 
      // If I remove them from UI, they disappear from UI next reload?
      // No, Backend `getHabitSections` returns DB rows.
      // If I don't delete them in DB, they return.
      // I need `deleteHabitSection`.
      // I should track IDs present at start vs end.

      const originalIds = (habitDataCache ? habitDataCache.sections : []).map(s => s.id);
      const currentIds = newSections.map(s => s.id).filter(id => id);

      const toDelete = originalIds.filter(id => !currentIds.includes(id));

      const delPromises = toDelete.map(id => {
        return new Promise((resolve) => {
          google.script.run.withSuccessHandler(resolve).deleteHabitSection(id);
        });
      });

      Promise.all([...promises, ...delPromises]).then(() => {
        closeSectionManager();
        fetchHabits();
      });
    }
    function runMigration() {
      if (!confirm('Migrate Data?')) return;
      const btn = document.getElementById('migration-btn');
      btn.innerText = 'Migrating...';
      google.script.run.withSuccessHandler((r) => {
        alert('Result: ' + r);
        console.warn("MIGRATION_RESULT:::" + r);
        btn.innerText = 'Done';
      }).migrateHabitDefinitions();
    }

    /* --- ROADMAP LOGIC --- */
    function fetchGoals() {
      const container = document.getElementById('goal-list-container');
      container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Loading...</div>';
      google.script.run
        .withSuccessHandler((goals) => {
          renderRoadmap(goals);
        })
        .withFailureHandler((e) => {
          console.error("Fetch Error", e);
          container.innerHTML = '<div style="color:red; padding:20px;">Load Error. Please reload.</div>';
        })
        .getGoalsV2();
    }

    function renderRoadmap(goals) {
      const container = document.getElementById('goal-list-container');
      container.innerHTML = '';

      if (!goals || goals.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa;">ç›®æ¨™ã‚’è¨­å®šã—ã¦ã€<br>ç†æƒ³ã®æœªæ¥ã‚’æãã¾ã—ã‚‡ã†ï¼</div>';
        return;
      }

      goals.forEach(g => {
        try {
          let start = g.startDate ? new Date(g.startDate) : new Date();
          let end = g.endDate ? new Date(g.endDate) : new Date(new Date().setFullYear(new Date().getFullYear() + 1));
          const now = new Date();

          if (isNaN(start.getTime())) start = new Date();
          if (isNaN(end.getTime())) end = new Date(new Date().setFullYear(new Date().getFullYear() + 1));

          // Progress Calculation (Time)
          const totalTime = end - start;
          const elapsedTime = now - start;
          const timePercent = (totalTime > 0) ? Math.max(0, Math.min(100, (elapsedTime / totalTime) * 100)) : 0;

          // Progress Calculation (Metric)
          let metricPercent = 0;
          const target = Number(g.metricTarget) || 0;
          const current = Number(g.metricCurrent) || 0;
          if (target > 0) {
            metricPercent = Math.max(0, Math.min(100, (current / target) * 100));
          }

          const displayPercent = (target > 0) ? metricPercent : timePercent;

          const endDateStr = g.endDate ? String(g.endDate).substring(0, 10) : 'No Date';

          const div = document.createElement('div');
          div.className = 'goal-card';
          div.innerHTML = `
                <div class="goal-header">
                   <div class="goal-title">${g.title || 'Untitled'}</div>
                   <div style="font-size:12px; color:${g.status === 'Active' ? '#4CAF50' : '#999'}; font-weight:bold;">${g.status}</div>
                </div>
                ${g.vision ? `<div class="goal-vision">${g.vision}</div>` : ''}
                
                <div class="goal-metrics">
                   <span>ç¾åœ¨: ${current}${g.metricLabel || ''}</span>
                   <span>ç›®æ¨™: ${target}${g.metricLabel || ''}</span>
                </div>
                
                <div class="progress-container">
                   <div class="progress-bar" style="width: ${displayPercent}%;"></div>
                </div>
                
                <div class="goal-dates">
                   <span>ğŸ ${endDateStr}</span>
                   <span style="margin-left:auto;">æ®‹ã‚Š ${(end - now) / (1000 * 60 * 60 * 24) > 0 ? Math.ceil((end - now) / (1000 * 60 * 60 * 24)) : 0} æ—¥</span>
                </div>
              `;
          div.onclick = () => openGoalDetail(g.id);
          container.appendChild(div);
        } catch (err) {
          console.error('Render Error Goal:', g, err);
          const errDiv = document.createElement('div');
          errDiv.innerText = 'Error loading goal: ' + g.title;
          container.appendChild(errDiv);
        }
      });
    }

    function openGoalModal() {
      document.getElementById('goal-modal').classList.add('open');
      // Reset inputs
      document.getElementById('g-id').value = '';
      document.getElementById('g-title').value = '';
      document.getElementById('g-vision').value = '';
      document.getElementById('g-metric-label').value = '';
      document.getElementById('g-metric-target').value = '';
      document.getElementById('g-metric-current').value = '';
      document.getElementById('g-start-date').value = new Date().toISOString().substring(0, 10);
      document.getElementById('g-end-date').value = '';
    }

    function closeGoalModal() {
      document.getElementById('goal-modal').classList.remove('open');
    }

    function saveGoal() {
      const id = document.getElementById('g-id').value;
      const title = document.getElementById('g-title').value;
      if (!title) return alert('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™');

      const goal = {
        id: id || null,
        title: title,
        vision: document.getElementById('g-vision').value,
        metricLabel: document.getElementById('g-metric-label').value,
        metricTarget: Number(document.getElementById('g-metric-target').value) || 0,
        metricCurrent: Number(document.getElementById('g-metric-current').value) || 0,
        startDate: document.getElementById('g-start-date').value,
        endDate: document.getElementById('g-end-date').value
      };

      closeGoalModal();
      google.script.run.withSuccessHandler(() => {
        fetchGoals();
      }).saveGoal(goal);
    }

    // Hook into tab switch (Simple hack: fetch every time tab clicked via DOM attrib? No, just fetch once on init)
    // Or we can expose fetchGoals global and add it to the onclick in HTML?
    // Yes, I'll update the nav item... oh wait, I already wrote the HTML.
    // Let's just run fetchGoals() on load for now.
    window.addEventListener('load', () => setTimeout(fetchGoals, 1000)); 
  </script>
  <?!= include('icons'); ?>

  <style>
    .cal-cell.status-failed {
      background: #F4F4F4;
      /* Light Gray Solid */
      color: #555;
      border: none;
      /* No Ring */
    }

    /* Today Unfinished */
    .cal-cell.status-today-incomplete {
      background: #F4F4F4;
      /* Matched Light Gray */
      color: var(--warm-orange);
      /* Orange Text */
      border: none;
      font-weight: 800;
    }

    .task-wrapper {
      position: relative;
      margin-bottom: 12px;
      /* Restore vertical gap */
      overflow: visible;
      /* Allow actions to be seen when swiped (controlled by opacity) */
      /* Wait, if visible, bleed happens? No, opacity 0 handles bleed. */
      /* Actually overflow: hidden clips 12px corners? Yes. */
      /* Let's keep overflow hidden to clip the actions to the card shape if opacity fails? */
      /* No, if we want actions to slide out? */
      /* Actions are inside wrapper. */
      overflow: hidden;
      border-radius: 12px;
      /* Restore rounded corners */
      background: transparent;
      border-bottom: none;
      /* No separator */
    }

    .task-item {
      /* Ensure it sits on top */
      position: relative;
      z-index: 2;
      background: #FFF !important;
      /* solid bg to cover actions */
      transition: transform 0.3s ease;
      margin-bottom: 0 !important;
      /* Wrapper creates spacing */
      padding: 12px 14px;
      /* Match header */
    }

    .task-actions {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 140px;
      display: flex;
      z-index: 1;
      opacity: 0;
      /* HIDDEN BY DEFAULT TO PREVENT BLEED */
      transition: opacity 0.1s ease;
    }

    .action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      color: white;
    }

    .action-btn.archive {
      background-color: #64B5F6;
      /* Blue for Archive */
    }

    .action-btn.unarchive {
      background-color: #8D6E63;
      /* Brown/Gray for Restore */
    }

    .action-btn.delete {
      background-color: #EF5350;
      /* Red for Delete */
    }

    /* Small Add Button in Header */
    .add-btn-small {
      font-size: 20px;
      color: #777;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .add-btn-small:active {
      background: #eee;

    }

    /* Roadmap Styles */
    .goal-card {
      background: white;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
      position: relative;
      overflow: hidden;
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .goal-title {
      font-size: 18px;
      font-weight: 800;
      color: #333;
      margin-bottom: 5px;
    }

    .goal-vision {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 15px;
      font-style: italic;
    }

    .progress-container {
      background: #F0F0F0;
      height: 8px;
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #64B5F6, #1E88E5);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .goal-metrics {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #888;
      margin-top: 5px;
      font-weight: 700;
    }

    .goal-dates {
      font-size: 11px;
      color: #AAA;
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .milestone-dots {
      display: flex;
      gap: 4px;
      margin-top: 10px;
    }

    .m-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #eee;
    }

    .m-dot.done {
      background: #81C784;
    }

    /* Fix Bottom Nav for 5 items (Robust Flex) */
    .bottom-nav {
      display: flex !important;
      flex-direction: row !important;
      justify-content: space-around !important;
      align-items: center !important;
      width: 100% !important;
      height: 70px !important;
      /* Fixed Height */
      padding: 0 5px !important;
      box-sizing: border-box !important;
      gap: 0 !important;
    }

    .nav-item {
      flex: 1 1 0px !important;
      /* Forces equal width */
      width: 0 !important;
      /* Robustness for old browsers */
      min-width: 0 !important;
      max-width: none !important;
      height: 100% !important;
      padding: 5px 0 !important;
      margin: 0 !important;
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      justify-content: center !important;
    }
  </style>
  <script>
    // --- GOALS ---
    function renderGoalsTab() {
      renderWeeklyFocus();
    }

    function renderWeeklyFocus() {
      const container = document.getElementById('weekly-focus-container');
      if (!container) { console.error('Container missing'); return; }
      container.innerHTML = '<div class="loading-spinner"></div>';

      // Pass today to backend
      const todayStr = new Date().toLocaleDateString('en-CA');

      google.script.run.withSuccessHandler(goals => {
        if (!goals || goals.length === 0) {
          container.innerHTML = `
            <div style="background:white; border-radius:18px; text-align:center; padding:30px; opacity:0.9; box-shadow:0 2px 10px rgba(0,0,0,0.02);">
                <div style="font-size:40px; margin-bottom:10px;">ğŸ¯</div>
                <div style="font-weight:bold; font-size:16px;">No Active Focus</div>
                <div style="font-size:12px; color:#999; margin-top:5px;">Set a weekly goal to start tracking.</div>
                <button class="btn-save" style="margin-top:15px;" onclick="openGoalWizard()">Set Focus</button>
            </div>
          `;
          return;
        }

        let html = '';
        goals.forEach(g => {
          const progress = (g.current_value / g.target_value) * 100;
          const progressClamped = Math.min(100, progress);
          const color = progress >= 100 ? '#4CAF50' : '#2196F3';

          html += `
                    <div class="goal-card" onclick="openMeasurementModal('${g.id}', '${g.target_metric}', '${g.title || g.goal_title}')">
                        <div class="goal-header" style="margin-bottom:10px;">
                            <div class="goal-title" style="font-size:16px;">${g.target_metric}</div>
                            <div style="font-size:12px; color:#666;">${g.current_value} / ${g.target_value}</div>
                        </div>
                        <div style="background:#eee; height:8px; border-radius:4px; overflow:hidden;">
                            <div style="background:${color}; width:${progressClamped}%; height:100%; transition:width 0.5s;"></div>
                        </div>
                        <div style="font-size:10px; color:#999; margin-top:8px; text-align:right;">
                            ${g.goal_title ? 'Linked to: ' + g.goal_title : 'Weekly Goal'}
                        </div>
                    </div>
                `;
        });
        container.innerHTML = html;
      }).withFailureHandler(err => {
        console.error('Failed to get goals', err);
        container.innerHTML = '<div style="color:red">Error loading goals: ' + err + '</div>';
      }).getWeeklyGoals(todayStr);
    }

    // Measurement Modal State
    let currentMeasurementGoalId = null;

    function openMeasurementModal(goalId, metricName, goalTitle) {
      currentMeasurementGoalId = goalId;
      document.getElementById('mm-title').innerText = metricName;
      document.getElementById('mm-subtitle').innerText = goalTitle;
      document.getElementById('mm-value').value = '';
      document.getElementById('measurement-modal').classList.add('open');
      setTimeout(() => document.getElementById('mm-value').focus(), 100);
    }

    function closeMeasurementModal() {
      document.getElementById('measurement-modal').classList.remove('open');
      currentMeasurementGoalId = null;
    }

    function saveMeasurement() {
      const val = document.getElementById('mm-value').value;
      const comment = document.getElementById('mm-comment').value;

      if (!val) return;

      closeMeasurementModal();

      const dateStr = new Date().toLocaleDateString('en-CA');

      // Optimistic UI? 
      // Simple reload for now
      renderWeeklyFocus(); // Show specific spinner?

      google.script.run.withSuccessHandler(() => {
        renderWeeklyFocus();
      }).logDailyMeasurement(currentMeasurementGoalId, val, comment, dateStr);
    }

    function openGoalWizard() {
      // Reset State
      document.getElementById('gw-step-1').style.display = 'block';
      document.getElementById('gw-step-2').style.display = 'none';
      document.getElementById('gw-btn-back').style.display = 'none';
      document.getElementById('gw-btn-next').innerText = 'Next';
      document.getElementById('gw-btn-next').onclick = gwNextStep;

      // Reset Inputs
      document.getElementById('gw-goal-select').innerHTML = '<option value="">Loading...</option>';
      document.getElementById('gw-new-goal-container').style.display = 'none';
      document.getElementById('gw-new-goal-title').value = '';
      document.getElementById('gw-metric-name').value = '';
      document.getElementById('gw-target-value').value = '';
      document.getElementById('gw-notes').value = '';

      document.getElementById('goal-wizard-modal').classList.add('open');

      // Fetch Goals
      google.script.run.withSuccessHandler(goals => {
        const sel = document.getElementById('gw-goal-select');
        sel.innerHTML = '<option value="">-- Select --</option>';
        if (goals && goals.length > 0) {
          goals.forEach(g => {
            sel.innerHTML += `<option value="${g.id}">${g.title}</option>`;
          });
        }
        sel.innerHTML += '<option value="new">+ Create New Goal...</option>';
      }).getActiveGoalsSimple();
    }

    function checkGwGoalSelect() {
      const val = document.getElementById('gw-goal-select').value;
      const newCont = document.getElementById('gw-new-goal-container');
      if (val === 'new') {
        newCont.style.display = 'block';
        setTimeout(() => document.getElementById('gw-new-goal-title').focus(), 100);
      } else {
        newCont.style.display = 'none';
      }
    }

    function gwNextStep() {
      // Validation Step 1
      const goalVal = document.getElementById('gw-goal-select').value;
      if (!goalVal) { alert('Please select a goal or create new.'); return; }
      if (goalVal === 'new' && !document.getElementById('gw-new-goal-title').value.trim()) {
        alert('Please enter a title for the new goal.'); return;
      }

      document.getElementById('gw-step-1').style.display = 'none';
      document.getElementById('gw-step-2').style.display = 'block';
      document.getElementById('gw-btn-back').style.display = 'block';
      document.getElementById('gw-btn-next').innerText = 'Set Focus';
      document.getElementById('gw-btn-next').onclick = gwSave;

      setTimeout(() => document.getElementById('gw-metric-name').focus(), 100);
    }

    function gwPrevStep() {
      document.getElementById('gw-step-2').style.display = 'none';
      document.getElementById('gw-step-1').style.display = 'block';
      document.getElementById('gw-btn-back').style.display = 'none';
      document.getElementById('gw-btn-next').innerText = 'Next';
      document.getElementById('gw-btn-next').onclick = gwNextStep;
    }

    function gwSave() {
      const metric = document.getElementById('gw-metric-name').value;
      const target = document.getElementById('gw-target-value').value;
      const notes = document.getElementById('gw-notes').value;

      if (!metric || !target) { alert('Please enter metric and target value.'); return; }

      // Prepare Data
      const goalSelect = document.getElementById('gw-goal-select').value;
      let goalId = goalSelect;

      // If New, we might need to handle creation on backend or pass a flag?
      // Current setWeeklyGoal expects goalId.
      // Let's modify setWeeklyGoal to handle "new:Title" convention? or create goal first?
      // Simpler: If goalId is "new", pass the TITLE in "notes" or separate param?
      // Actually, let's just pass "new" and the title in notes is hacky.
      // Let's pass goalId (which is 'new') and include the New Title in the call.
      // I need to update setWeeklyGoal signature? Or just repurpose.

      const newTitle = document.getElementById('gw-new-goal-title').value;

      const startDate = new Date();
      const day = startDate.getDay() || 7; // Mon=1, Sun=7
      if (day !== 1) startDate.setDate(startDate.getDate() - (day - 1)); // Back to Monday
      const startDateStr = startDate.toLocaleDateString('en-CA');

      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6); // To Sunday
      const endDateStr = endDate.toLocaleDateString('en-CA');

      document.getElementById('goal-wizard-modal').classList.remove('open');
      renderWeeklyFocus(); // Spinner

      // If goalId is 'new', we need the title. 
      // Let's pass it as a composite or extra arg? 
      // setWeeklyGoal(goalId, metric, target, notes, start, end, newGoalTitle)

      google.script.run.withSuccessHandler(res => {
        renderWeeklyFocus();
      }).setWeeklyGoal(goalId, metric, target, notes, startDateStr, endDateStr, newTitle);
    }

  </script>

  <!-- MEASUREMENT MODAL -->
  <div class="modal-overlay" id="measurement-modal" onclick="if(event.target===this) closeMeasurementModal()">
    <div class="modal-box">
      <h3 id="mm-title">Metric Name</h3>
      <div id="mm-subtitle" style="font-size:12px; color:#999; margin-bottom:15px;">Goal Title</div>

      <label style="font-size:12px; color:#666;">Value (Today)</label>
      <input id="mm-value" type="number" class="input-std" placeholder="e.g. 5">

      <label style="font-size:12px; color:#666; margin-top:10px; display:block;">Comment</label>
      <input id="mm-comment" type="text" class="input-std" placeholder="Optional">

      <button class="btn-save" style="margin-top:20px;" onclick="saveMeasurement()">Log</button>
    </div>
  </div>
  <!-- GOAL WIZARD MODAL -->
  <div class="modal-overlay" id="goal-wizard-modal">
    <div class="modal-box" style="min-height:300px; display:flex; flex-direction:column;">
      <div style="flex:1;">
        <h3 style="margin-bottom:5px;">Weekly Plan ğŸ—“ï¸</h3>
        <div style="font-size:12px; color:#999; margin-bottom:20px;">Set your focus for this week.</div>

        <!-- Step 1: Select Parent Goal -->
        <div id="gw-step-1">
          <label class="label-std">Select a Vision / Goal</label>
          <select id="gw-goal-select" class="input-std" onchange="checkGwGoalSelect()">
            <option value="">Loading...</option>
          </select>

          <div id="gw-new-goal-container" style="display:none; margin-top:10px;">
            <label class="label-std">New Goal Title</label>
            <input id="gw-new-goal-title" class="input-std" placeholder="e.g. Master Python">
          </div>
        </div>

        <!-- Step 2: Define Weekly Target -->
        <div id="gw-step-2" style="display:none;">
          <label class="label-std">What to measure this week?</label>
          <input id="gw-metric-name" class="input-std" placeholder="e.g. Pages Read, Hours Studied">

          <label class="label-std" style="margin-top:15px;">Target Value</label>
          <div style="display:flex; align-items:center; gap:10px;">
            <input id="gw-target-value" type="number" class="input-std" style="flex:1;" placeholder="10">
            <span style="font-size:12px; color:#666;">Total</span>
          </div>

          <label class="label-std" style="margin-top:15px;">Notes (Optional)</label>
          <input id="gw-notes" class="input-std" placeholder="Strategy...">
        </div>
      </div>

      <!-- Footer Buttons -->
      <div style="display:flex; justify-content:space-between; margin-top:20px;">
        <button id="gw-btn-back" class="btn-save"
          style="background:#eee; color:#555; width:auto; padding:0 20px; display:none;"
          onclick="gwPrevStep()">Back</button>
        <div style="flex:1;"></div>
        <button id="gw-btn-next" class="btn-save" style="width:auto; padding:0 30px;"
          onclick="gwNextStep()">Next</button>
      </div>
    </div>
  </div>
</body>

</html>